<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.10.0" />
<title>safeserializer.compression API documentation</title>
<meta name="description" content="" />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>safeserializer.compression</code></h1>
</header>
<section id="section-intro">
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">#  Copyright (c) 2023. Davi Pereira dos Santos
#  This file is part of the safeserializer project.
#  Please respect the license - more about this in the section (*) below.
#
#  safeserializer is free software: you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published by
#  the Free Software Foundation, either version 3 of the License, or
#  (at your option) any later version.
#
#  safeserializer is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU General Public License for more details.
#
#  You should have received a copy of the GNU General Public License
#  along with safeserializer.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
#
#  (*) Removing authorship by any means, e.g. by distribution of derived
#  works or verbatim, obfuscated, compiled or rewritten versions of any
#  part of this work is illegal and unethical regarding the effort and
#  time spent here.
import pickle
from binascii import hexlify, unhexlify

import bson
from bson import InvalidDocument
from orjson import orjson


def topickle(obj, ensure_determinism):
    &#34;&#34;&#34;
    &gt;&gt;&gt; f = print
    &gt;&gt;&gt; du = topickle({&#34;a&#34;: [3, f]}, ensure_determinism=False)
    &gt;&gt;&gt; res = frompickle(du)
    &gt;&gt;&gt; res[&#34;a&#34;][1]() is None
    &lt;BLANKLINE&gt;
    True
    &gt;&gt;&gt; frompickle(topickle({&#34;a&#34;: [3, None]}, ensure_determinism=True))
    {&#39;a&#39;: [3, None]}
    &#34;&#34;&#34;
    try:
        prefix = b&#34;05pckl_&#34;
        dump = pickle.dumps(obj, protocol=5)
    except Exception as e:  # pragma: no cover
        if ensure_determinism:
            print(e)
            raise NondeterminismException(&#34;Cannot serialize deterministically.&#34;)
        import dill

        try:
            prefix = b&#34;05dill_&#34;
            dump = dill.dumps(obj, protocol=5)
        except KeyError as e:
            if str(e) == &#34;&#39;__getstate__&#39;&#34;:
                raise Exception(&#34;Unpickable value:&#34;, type(obj))
            else:
                raise e
    blob = prefix + dump
    return blob


def frompickle(blob):
    &#34;&#34;&#34;
    &gt;&gt;&gt; du = frompickle(b&#39;05pckl_\\x80\\x05\\x95#\\x00\\x00\\x00\\x00\\x00\\x00\\x00}\\x94\\x8c\\x01a\\x94]\\x94(K\\x03\\x8c\\x08builtins\\x94\\x8c\\x05print\\x94\\x93\\x94es.&#39;)
    &gt;&gt;&gt; du[&#34;a&#34;][1]() is None
    &lt;BLANKLINE&gt;
    True
    &#34;&#34;&#34;
    prefix = blob[:7]
    blob = blob[7:]
    if prefix == b&#34;05pckl_&#34;:
        return pickle.loads(blob)
    elif prefix == b&#34;05dill_&#34;:  # pragma: no cover
        import dill

        return dill.loads(blob)


def traversal_enc(obj, ensure_determinism, unsafe_fallback):
    &#34;&#34;&#34;
    TODO: Fix nested tuples being converted to lists by json?
        &#39;tuple&#39; should make orjson/bson raise an exception like it would happen for hditc,
        it would be easy to handle like with other non built-in types.
    &gt;&gt;&gt; unpack(pack([&#34;a&#34;, [&#34;3&#34;, 4], &#34;b&#34;, 4], ensure_determinism=False, unsafe_fallback=False))
    [&#39;a&#39;, [&#39;3&#39;, 4], &#39;b&#39;, 4]
    &gt;&gt;&gt; unpack(pack([{0: [{&#34;3&#34;:4}], &#34;b&#34;: b&#34;b&#34;}], ensure_determinism=False, unsafe_fallback=False))
    [{0: [{&#39;3&#39;: 4}], &#39;b&#39;: b&#39;b&#39;}]
    &gt;&gt;&gt; du = pack(True, ensure_determinism=False, unsafe_fallback=True, compressed=False)
    &gt;&gt;&gt; du
    b&#39;00json_true&#39;
    &gt;&gt;&gt; unpack(du)
    True
    &gt;&gt;&gt; unpack(pack([True], ensure_determinism=False, unsafe_fallback=True, compressed=False))
    [True]
    &gt;&gt;&gt; unpack(pack([{&#34;a&#34;: b&#34;some bytes&#34;, &#34;b&#34;:print}], ensure_determinism=False, unsafe_fallback=True))[0][&#34;a&#34;]
    b&#39;some bytes&#39;
    &gt;&gt;&gt; unpack(pack(b&#34;some bytes&#34;, ensure_determinism=False, unsafe_fallback=True))
    b&#39;some bytes&#39;
    &gt;&gt;&gt; unpack(pack(99999999999999999999999999999999999999999, ensure_determinism=False, unsafe_fallback=True))
    99999999999999999999999999999999999999999
    &gt;&gt;&gt; from pandas import Series as S, DataFrame as DF
    &gt;&gt;&gt; s = S({&#34;a&#34;: 5, &#34;b&#34;: 6}, name=&#34;column&#34;)
    &gt;&gt;&gt; a = pack(s, ensure_determinism=True, unsafe_fallback=False)
    &gt;&gt;&gt; a  # doctest: +SKIP
    b&#39;00lz4__\\x04&#34;M\\x18h@^\\x00\\x00\\x00\\x00\\x00\\x00\\x00@\\\\\\x00\\x00\\x00\\xf1\\x0e00bsos_W\\x00\\x00\\x00\\x04i\\x00\\x17\\x00\\x00\\x00\\x020\\x00\\x02\\x00\\x00\\x00a\\x00\\x021\\t\\x00\\xf0\\nb\\x00\\x00\\x05v\\x00&#34;\\x00\\x00\\x00\\x0016\\xc2\\xa71\\xc2\\xa7int64\\xc2\\xa7&amp;\\x00\\x10\\x05\\x17\\x00A\\x00\\x00\\x00\\x06\\x06\\x00\\xf0\\x02\\x00\\x00\\x02n\\x00\\x07\\x00\\x00\\x00column\\x00\\x00\\x00\\x00\\x00\\x00&#39;
    &gt;&gt;&gt; unpack(a)
    a    5
    b    6
    Name: column, dtype: int64
    &gt;&gt;&gt; s = S({&#34;a&#34;: &#34;5&#34;, &#34;b&#34;: &#34;6&#34;})
    &gt;&gt;&gt; b = pack(s, ensure_determinism=True, unsafe_fallback=False)
    &gt;&gt;&gt; b
    b&#39;00lz4__\\x04&#34;M\\x18h@\\x1d\\x08\\x00\\x00\\x00\\x00\\x00\\x00\\xec\\xe2\\x04\\x00\\x00\\xf0\\x1100prqs_PAR1\\x15\\x04\\x15\\x14\\x15\\x18L\\x15\\x04\\x15\\x00\\x12\\x00\\x00\\n$\\x01\\x00\\x00\\x005\\x05\\x00\\xf696\\x15\\x00\\x15\\x12\\x15\\x16,\\x15\\x04\\x15\\x10\\x15\\x06\\x15\\x06\\x1c6\\x00(\\x016\\x18\\x015\\x00\\x00\\x00\\t \\x02\\x00\\x00\\x00\\x04\\x01\\x01\\x03\\x02&amp;\\x88\\x01\\x1c\\x15\\x0c\\x195\\x10\\x00\\x06\\x19\\x18\\x06_none_\\x15\\x02\\x16\\x04\\x16x\\x16\\x80\\x01&amp;&lt;&amp;\\x088\\x00\\x10\\x19L\\x00\\x90\\x00\\x15\\x02\\x00\\x15\\x00\\x15\\x10\\x15B\\x00\\x0f}\\x00\\x01\\x10a}\\x00\\x1fb}\\x00\\x01Kb\\x18\\x01a}\\x00&amp;\\x82\\x03}\\x00\\xf7\\x02\\x11__index_level_0_\\x88\\x00Q\\xb6\\x02&amp;\\x82\\x02\\x8a\\x00\\x01E\\x00\\x0f\\x8a\\x00\\x01\\xf4\\x04\\x19&lt;5\\x00\\x18\\x06schema\\x15\\x04\\x00\\x15\\x0c%\\x02\\xd0\\x00b%\\x00L\\x1c\\x00\\x00\\x13\\x00\\x0ef\\x00\\x03\\x1e\\x00o\\x16\\x04\\x19\\x1c\\x19,\\x0f\\x01*\\x0f\\xcf\\x007\\xf2\\r\\x16\\xf0\\x01\\x16\\x04&amp;\\x08\\x16\\x80\\x02\\x14\\x00\\x00\\x19,\\x18\\x06pandas\\x18\\xfc\\x03{&#34;%\\x01\\xcdcolumns&#34;: [&#34;9\\x01R&#34;], &#34;&#34;\\x00\\x02T\\x01\\x11e)\\x00\\xfa\\x07{&#34;name&#34;: null, &#34;field_\\x14\\x00\\x02i\\x00@_typ)\\x00\\xf5\\x02&#34;unicode&#34;, &#34;numpy\\x19\\x00`object\\x18\\x00\\xf6\\x12metadata&#34;: {&#34;encoding&#34;: &#34;UTF-8&#34;}}\\x8d\\x00\\n\\x86\\x00\\x12&#34;n\\x02\\x00D\\x00\\t\\x8a\\x00\\x07\\x18\\x00\\x0f\\x8e\\x00*\\x00\\xe6\\x00?}, \\xf6\\x00\\n\\x0f&lt;\\x01\\x00\\x0fw\\x002\\x01\\xf4\\x00areator\\x18\\x01plibrary\\x17\\x01ppyarrow\\xf7\\x00pversion\\x16\\x00\\x8611.0.0&#34;}~\\x00\\x08\\x1d\\x00\\xf2\\x00.5.3&#34;}\\x00\\x18\\x0cARROW:\\xe6\\x02@\\x18\\xe0\\x07/\\x01\\x00\\x82+ACAAAQA\\x01\\x00\\xf1\\x00KAA4ABgAFAAgACg\\x15\\x00)BB \\x00\\x10w\\x15\\x00\\x15E \\x00 DQ@\\x00\\x10E\\x15\\x00\\x02F\\x00\\x01 \\x00\\x10I\\x08\\x00\\x11B\\x08\\x00\\x01E\\x00\\x10I \\x00\\x02%\\x00\\xf4FYAAABwYW5kYXMAAPwBAAB7ImluZGV4X2NvbHVtbnMiOiBbIl9faW5kZXhfbGV2ZWxfMF9fIl0sICJjb2x1bW5$\\x00\\xf0\\x01lcyI6IFt7Im5hbWUD\\x00\\xf3\\x15udWxsLCAiZmllbGRfbmFtZSI6IG51bGwsICJ\\x90\\x00aNfdHlw\\x1c\\x00\\xf0\\x0eCJ1bmljb2RlIiwgIm51bXB5X3R5cGX\\x00\\xa2Aib2JqZWN0 \\x00\\xf0\\x0c1ldGFkYXRhIjogeyJlbmNvZGluZ\\x94\\x00\\xd9CJVVEYtOCJ9fV\\xbc\\x00\\x10z0\\x00EW3si\\x98\\x00\\xbfCJfbm9uZV8i\\xb8\\x00\\x02\\x0b \\x00\\x88cGFuZGFz\\x9c\\x00\\xb0dW5pY29kZSI\\xe0\\x00\\xd0udW1weV90eXBlp\\x00\\xa1Im9iamVjdC \\x00\\xa5tZXRhZGF0Y\\x18\\x01@x9LC\\x98\\x01\\x0fH\\x01\\x10TCJfX2\\xc0\\x01\\xc1xldmVsXzBfXy\\\\\\x00\\x0f\\\\\\x01&gt;\\x80bnVsbH1d\\x1c\\x01\\xf0\\nY3JlYXRvciI6IHsibGlicmFye\\xc8\\x00\\xb1CJweWFycm93\\xa4\\x01\\xa1nZlcnNpb24\\xc0\\x01\\xa1MTEuMC4wIn\\x90\\x01\\x06\\xa8\\x00\\x80mVyc2lvbT\\x00\\xb0CIxLjUuMyJ9\\xc4\\x02\\x02\\xcb\\x02 BM\\n\\x00\\x10B\\x05\\x00\\xb1Mz///8AAAEF\\xe0\\x02\\x11CK\\x03\\x01\\x0b\\x00\\x01\\x02\\x00\\x10B\\x0b\\x00\\x1fB \\x01\\x03`wAAAMj@\\x00@QABQ\\x89\\x03`GAAcAD9\\x00\\x17BE\\x00!QUU\\x00\\x10H\\x18\\x00\\x02e\\x03\\x01\\x02\\x00\\x10B[\\x03\\x94F9ub25lXw3\\x00\\x01+\\x00\\x01\\x02\\x00\\xf1\\x00\\x00\\x18 parquet-cpp-9\\x04\\x13 \\x19\\x04\\x12 3\\x04P\\x19,\\x1c\\x00\\x00\\xdf\\x06\\x80\\x03\\x07\\x00\\x00PAR1\\x00\\x00\\x00\\x00&#39;
    &gt;&gt;&gt; unpack(b)
    a    5
    b    6
    dtype: object
    &gt;&gt;&gt; s = S({&#34;a&#34;: &#34;5&#34;, &#34;b&#34;: 6}, name=&#34;column&#34;)
    &gt;&gt;&gt; unpack(pack(s, ensure_determinism=True, unsafe_fallback=True))
    a    5
    b    6
    Name: column, dtype: object
    &gt;&gt;&gt; df = DF({&#34;a&#34;: [&#34;5&#34;,&#34;6&#34;,&#34;7&#34;], &#34;b&#34;: [1,2,3]}, index=[&#34;x&#34;,&#34;y&#34;,&#34;z&#34;])
    &gt;&gt;&gt; unpack(pack(df, ensure_determinism=True, unsafe_fallback=False))
       a  b
    x  5  1
    y  6  2
    z  7  3
    &gt;&gt;&gt; df = DF({&#34;a&#34;: [&#34;5&#34;,6,&#34;7&#34;], &#34;b&#34;: [&#34;1&#34;,&#34;2&#34;,&#34;3&#34;]}, index=[&#34;x&#34;,&#34;y&#34;,&#34;z&#34;])
    &gt;&gt;&gt; unpack(pack(df, ensure_determinism=True, unsafe_fallback=True))
       a  b
    x  5  1
    y  6  2
    z  7  3
    &#34;&#34;&#34;
    error = None
    if isinstance(obj, bytes):
        return obj
    if isinstance(obj, tuple):
        lst_of_binaries = tuple(traversal_enc(o, ensure_determinism, unsafe_fallback) for o in obj)
        return b&#34;00tupl_&#34; + bson.encode({&#34;_&#34;: lst_of_binaries})

    try:
        return b&#34;00json_&#34; + orjson.dumps(obj)
    except TypeError as e:
        error = str(e)
    try:
        return b&#34;00bson_&#34; + bson.encode({&#34;_&#34;: obj})
    except InvalidDocument as e:
        error = str(e)
    except OverflowError as o:
        if &#34;8-byte ints&#34; in str(o) and isinstance(obj, int):
            return b&#34;00bint_&#34; + str(obj).encode()

    if isinstance(obj, list):
        lst_of_binaries = [traversal_enc(o, ensure_determinism, unsafe_fallback) for o in obj]
        return b&#34;00list_&#34; + bson.encode({&#34;_&#34;: lst_of_binaries})
    elif isinstance(obj, dict):
        dic_of_binaries = {}
        hexfy = any(not isinstance(k, str) for k in obj.keys())
        prefix = b&#34;00dicB_&#34; if hexfy else b&#34;00dict_&#34;
        for k, o in obj.items():
            if hexfy:
                bk = traversal_enc(k, ensure_determinism, unsafe_fallback)
                k = hexlify(bk).decode(&#34;utf-8&#34;)
            dic_of_binaries[k] = traversal_enc(o, ensure_determinism, unsafe_fallback)
        return prefix + bson.encode(dic_of_binaries)

    klass = str(obj.__class__)
    if klass in [&#34;&lt;class &#39;numpy.ndarray&#39;&gt;&#34;]:
        return serialize_numpy(obj, ensure_determinism, unsafe_fallback)
    elif klass == &#34;&lt;class &#39;pandas.core.series.Series&#39;&gt;&#34;:
        try:
            idx = obj.index.values.tolist()
            vals = serialize_numpy(obj.to_numpy(), ensure_determinism, False, b&#34;&#34;)
            dic = {&#34;i&#34;: idx, &#34;v&#34;: vals}
            if obj.name is not None:
                dic[&#34;n&#34;] = obj.name
            return b&#34;00bsos_&#34; + bson.encode(dic)
        except Exception as e:
            if str(e).startswith(&#34;Please enable &#39;unsafe_fallback&#39;&#34;):
                from pandas import DataFrame

                try:
                    return b&#34;00prqs_&#34; + obj.to_frame(obj.name or &#34;_none_&#34;).to_parquet()  # .convert_dtypes().to_parquet()
                except Exception as e:
                    error = str(e)
    elif klass == &#34;&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;&#34;:
        try:
            return serialize_numpy(obj.to_numpy(), ensure_determinism, unsafe_fallback=False, prefix=b&#34;00npdf_&#34;)
        except Exception as e:
            if str(e).startswith(&#34;Please enable &#39;unsafe_fallback&#39;&#34;):
                try:
                    return b&#34;00prqd_&#34; + obj.to_parquet()
                except Exception as e:
                    error = str(e)
    if unsafe_fallback:
        return topickle(obj, ensure_determinism)
    raise Exception(f&#34;Cannot safely pack {type(obj)}: {error}&#34;)  # pragma: no cover
    # TODO: handle hdict?


def traversal_dec(dump):
    if isinstance(dump, bytes):
        header = dump[2:7]
        blob = dump[7:]
        if header == b&#34;json_&#34;:
            return orjson.loads(blob)
        if header == b&#34;bson_&#34;:
            return bson.decode(blob)[&#34;_&#34;]
        if header == b&#34;bint_&#34;:
            return int(blob.decode())
        if header == b&#34;nmpy_&#34;:
            return deserialize_numpy(blob)
        if header == b&#34;prqs_&#34;:
            import pandas as pd
            from io import BytesIO

            obj = pd.read_parquet(BytesIO(blob)).squeeze()
            if obj.name == &#34;_none_&#34;:
                obj.rename(None, inplace=True)
            return obj
        if header == b&#34;bsos_&#34;:
            from pandas import Series

            dec = bson.decode(blob)
            obj = deserialize_numpy(dec[&#34;v&#34;])
            kwargs = {&#34;name&#34;: dec[&#34;n&#34;]} if &#34;n&#34; in dec else {}
            return Series(obj, dec[&#34;i&#34;], **kwargs)
        if header == b&#34;prqd_&#34;:
            import pandas as pd
            from io import BytesIO

            return pd.read_parquet(BytesIO(blob))
        if header == b&#34;npdf_&#34;:
            from pandas import DataFrame

            return DataFrame(deserialize_numpy(blob))
        if header == b&#34;list_&#34;:
            return traversal_dec(bson.decode(blob)[&#34;_&#34;])
        if header == b&#34;tupl_&#34;:
            return traversal_dec(tuple(bson.decode(blob)[&#34;_&#34;]))
        if header == b&#34;dict_&#34;:
            return traversal_dec(bson.decode(blob))
        if header == b&#34;dicB_&#34;:
            decoded = bson.decode(blob).items()
            return {traversal_dec(unhexlify(k.encode(&#34;utf-8&#34;))): traversal_dec(v) for k, v in decoded}
        if header in [b&#34;pckl_&#34;, b&#34;dill_&#34;]:
            return frompickle(dump)
        return dump
    # if isinstance(dump, (int, str, bool)):
    #     return dump
    if isinstance(dump, tuple):
        return tuple(traversal_dec(d) for d in dump)
    if isinstance(dump, list):
        return [traversal_dec(d) for d in dump]
    if isinstance(dump, dict):
        return {k: traversal_dec(v) for k, v in dump.items()}
    raise Exception(f&#34;Cannot unpack {type(dump)}.&#34;)  # pragma: no cover


def pack(obj, ensure_determinism, unsafe_fallback, compressed=True):
    r&#34;&#34;&#34;
    Serialize &#39;obj&#39; to bytes.

    Attempt to serialize using one of the following options, in this order:
        orjson
        bson
        bigints as str
        numpy ndarray as raw bytes
        pandas numeric Series/DataFrame as ndarray raw bytes
        pandas ill-behaved Series/DataFrame as parquet
        pickle when &#39;unsafe_fallback=True&#39;
        dill when &#39;ensure_determinism=False&#39;.

    &gt;&gt;&gt; import numpy as np
    &gt;&gt;&gt; d = [[np.array([[1, 2/3], [4, 5]]), {&#34;x&#34;: b&#34;dsa&#34;}], [b&#34;asd&#34;, 5]]
    &gt;&gt;&gt; blob = pack(d, ensure_determinism=True, unsafe_fallback=False)
    &gt;&gt;&gt; unpack(blob)
    [[array([[1.        , 0.66666667],
           [4.        , 5.        ]]), {&#39;x&#39;: b&#39;dsa&#39;}], [b&#39;asd&#39;, 5]]
    &gt;&gt;&gt; blob = pack(d, ensure_determinism=True, unsafe_fallback=False, compressed=False)
    &gt;&gt;&gt; unpack(blob)
    [[array([[1.        , 0.66666667],
           [4.        , 5.        ]]), {&#39;x&#39;: b&#39;dsa&#39;}], [b&#39;asd&#39;, 5]]
    &gt;&gt;&gt; import pandas as pd
    &gt;&gt;&gt; df = pd.DataFrame(np.array([[1, 2/3], [4, 5]]))
    &gt;&gt;&gt; unpack(pack(df, ensure_determinism=True, unsafe_fallback=False))
         0         1
    0  1.0  0.666667
    1  4.0  5.000000

    &gt;&gt;&gt; unpack(pack({&#34;0&#34;: 3, &#34;b&#34;: print}, ensure_determinism=True, unsafe_fallback=True, compressed=False))
    {&#39;0&#39;: 3, &#39;b&#39;: &lt;built-in function print&gt;}
    &gt;&gt;&gt; unpack(pack({&#34;0&#34;: 3, &#34;b&#34;: b&#34;b&#34;}, ensure_determinism=True, unsafe_fallback=False, compressed=False))
    {&#39;0&#39;: 3, &#39;b&#39;: b&#39;b&#39;}
    &#34;&#34;&#34;
    dump = traversal_enc(obj, ensure_determinism, unsafe_fallback)
    if compressed:
        import lz4.frame as lz4

        return b&#34;00lz4__&#34; + lz4.compress(dump)
    return dump


def unpack(blob):
    &#34;&#34;&#34;
    &gt;&gt;&gt; from pandas import DataFrame as DF
    &gt;&gt;&gt; df = DF({&#34;a&#34;: [&#34;5&#34;, &#34;6&#34;, &#34;7&#34;], &#34;b&#34;: [1, 2, 3]}, index=[&#34;x&#34;, &#34;y&#34;, &#34;z&#34;])
    &gt;&gt;&gt; complex_data = {&#34;a&#34;: b&#34;Some binary content&#34;, (&#34;mixed-types tuple as a key&#34;, 4): 123, &#34;df&#34;: df}
    &gt;&gt;&gt; complex_data
    {&#39;a&#39;: b&#39;Some binary content&#39;, (&#39;mixed-types tuple as a key&#39;, 4): 123, &#39;df&#39;:    a  b
    x  5  1
    y  6  2
    z  7  3}
    &gt;&gt;&gt; dump = pack(complex_data, ensure_determinism=False, unsafe_fallback=False)
    &gt;&gt;&gt; dump
    b&#39;00lz4__\\x04&#34;M\\x18h@h\\x0b\\x00\\x00\\x00\\x00\\x00\\x00\\x94\\x95\\x06\\x00\\x00\\xf1*00dicB_a\\x0b\\x00\\x00\\x0530306a736f6e5f226122\\x00\\x13\\x00\\x00\\x00\\x00Some binary content.\\x00\\xd27475706c5f480\\x01\\x00b45f004\\x0c\\x00\\x8000530002\\x05\\x00\\x01\\x02\\x00\\rb\\x00\\xf5\\x07d697865642d74797065732X\\x00`652061\\x12\\x00\\xf4\\x0461206b6579220531000r\\x00\\x0bV\\x00\\x113}\\x00 \\x00\\n\\xb8\\x00\\xa100json_123\\xaf\\x00\\t\\xdd\\x00p46622\\x00b(\\x00\\xf0\\x1100prqd_PAR1\\x15\\x04\\x15\\x1e\\x15&#34;L\\x15\\x06\\x15\\x00\\x12\\x00\\x00\\x0f8\\x01\\x00\\x00\\x005\\x05\\x00\\x106\\x05\\x00\\xf667\\x15\\x00\\x15\\x14\\x15\\x18,\\x15\\x06\\x15\\x10\\x15\\x06\\x15\\x06\\x1c6\\x00(\\x017\\x18\\x015\\x00\\x00\\x00\\n$\\x02\\x00\\x00\\x00\\x06\\x01\\x02\\x03$\\x00&amp;\\x94\\x01\\x1c\\x15\\x0c\\x195\\x10\\x00\\x06\\x19\\x18\\x01a\\x15\\x02\\x16\\x06\\x16\\x84\\x01\\x16\\x8c\\x01&amp;F&amp;\\x085\\x00\\xe0\\x19,\\x15\\x04\\x15\\x00\\x15\\x02\\x00\\x15\\x00\\x15\\x10\\x15?\\x00d\\x15\\x04\\x150\\x15.\\x7f\\x00p\\x18\\x04\\x01\\x00\\t\\x01&lt;\\x19\\x00\\x00\\x02\\x00\\x10\\x03\\x05\\x00 \\x00\\x00.\\x00\\t\\x85\\x00$\\x18\\x08\\x1a\\x00 \\x18\\x08\\xa6\\x00\\x00\\x02\\x00?\\x16\\x00(\\x16\\x00\\x00\\x0c\\xa7\\x00T\\xe2\\x03\\x1c\\x15\\x04\\xa7\\x00\\x11b\\xa7\\x00\\xbf\\xda\\x01\\x16\\xdc\\x01&amp;\\xd0\\x02&amp;\\x86\\x02Y\\x00\\x19\\x0f\\xcb\\x00\\x02\\rJ\\x01\\x10x\\x9f\\x00\\x10y\\x05\\x00\\x1fzJ\\x01\\x01Lz\\x18\\x01x\\xa3\\x00&amp;\\xa8\\x06J\\x01\\xf1\\x03\\x11__index_level_0__\\xb3\\x00\\x02Z\\x01Q\\xda\\x05&amp;\\x9c\\x05\\x91\\x01\\x01G\\x00\\x0f\\x91\\x00\\x01\\xf0\\x0b\\x19L5\\x00\\x18\\x06schema\\x15\\x06\\x00\\x15\\x0c%\\x02\\x18\\x01a%\\x00L\\x1cV\\x01\\x10\\x04\\x0e\\x00\\x12b\\x16\\x00\\x0ej\\x00\\x03&amp;\\x00o\\x16\\x06\\x19\\x1c\\x19&lt;\\xe0\\x01&amp;\\x0fr\\x01J\\x0f,\\x018\\xb0\\x16\\xe2\\x03\\x16\\x06&amp;\\x08\\x16\\xf4\\x03\\x14\\xdc\\x01\\xd2\\x18\\x06pandas\\x18\\xd5\\x04{&#34;\\x83\\x01\\xcdcolumns&#34;: [&#34;\\x97\\x01R&#34;], &#34;&#34;\\x00\\x02\\xb2\\x01\\x11e)\\x00\\xfa\\x07{&#34;name&#34;: null, &#34;field_\\x14\\x00\\x02i\\x00@_typ)\\x00\\xf5\\x02&#34;unicode&#34;, &#34;numpy\\x19\\x00`object\\x18\\x00\\xf6\\x12metadata&#34;: {&#34;encoding&#34;: &#34;UTF-8&#34;}}\\x8d\\x00\\n\\x86\\x00 &#34;a?\\x00\\t\\x85\\x00\\x02\\x13\\x00\\x0f\\x84\\x00*\\x00\\xdc\\x005}, \\xec\\x00.&#34;bf\\x00\\x01\\x13\\x00\\x0bf\\x00Pint64+\\x00\\n\\xe8\\x00\\x05\\x17\\x00\\x07\\xe7\\x00\\x0cc\\x00\\x00\\x10\\x00\\x0cO\\x01\\x0f\\x95\\x01\\x00\\x0et\\x00\\x0f^\\x01\\x1b\\x00g\\x00\\x02M\\x01areatorq\\x01plibraryp\\x01ppyarrow\\xc4\\x00pversion\\x16\\x00\\x8611.0.0&#34;}~\\x00\\x08\\x1d\\x00\\xf2\\x00.5.3&#34;}\\x00\\x18\\x0cARROW:\\x9c\\x03@\\x18\\x98\\t/\\x01\\x00\\x822gDAAAQA\\x01\\x00\\xf1\\x00KAA4ABgAFAAgACg\\x15\\x00)BB \\x00\\x10w\\x15\\x00\\x15E \\x002IwC\\x10\\x00\\x04F\\x00\\x01 \\x00\\x10I\\x08\\x00\\x11B\\x08\\x00\\x01E\\x00\\x10I \\x00\\x10E\\x05\\x00\\xf4GAYAAABwYW5kYXMAAFUCAAB7ImluZGV4X2NvbHVtbnMiOiBbIl9faW5kZXhfbGV2ZWxfMF9fIl0sICJjb2x1bW5$\\x00\\xf0\\x01lcyI6IFt7Im5hbWUD\\x00\\xf0\\x11udWxsLCAiZmllbGRfbmFtZSI6IG51bGwH\\x00\\x03\\x90\\x00aNfdHlw\\x1c\\x00\\xf0\\x0eCJ1bmljb2RlIiwgIm51bXB5X3R5cGX\\x00\\xa2Aib2JqZWN0 \\x00\\xf0\\x0c1ldGFkYXRhIjogeyJlbmNvZGluZ\\x94\\x00\\xe0CJVVEYtOCJ9fV0t\\x00\\x04\\xbc\\x00\\x10z0\\x00EW3si\\x98\\x002CJhT\\x00\\x84ZpZWxkX2\\xcc\\x00PAiYSI&lt;\\x00\\x0f\\xb0\\x00&gt;\\xa9bnVsbH0sIH\\x88\\x00\\x1fi\\x88\\x00\\x06\\x1fi\\x88\\x00\\x06qpbnQ2NC \\x00\\xd0udW1weV90eXBl\\xe8\\x00\\x00\\xe8\\x01?dDY4\\x01\\x02\\x0f\\x84\\x00\\x02\\x06\\xa4\\x01\\xc2maWVsZF9uYW1L\\x00\\x0f\\x1c\\x02\\x05\\x00\\xb0\\x01\\x97nBhbmRhc1|\\x00PnVuaW\\x94\\x01 Ui\\x10\\x02xbnVtcHl\\xf4\\x01\\x82vYmplY3Q \\x00\\xa5WV0YWRhdGEH\\x02\\x04\\xbc\\x01\\x80cmVhdG9y\\xd4\\x00\\xc0eyJsaWJyYXJ5\\x10\\x00\\xb1InB5YXJyb3cH\\x00\\xf9\\x0bdmVyc2lvbiI6ICIxMS4wLjAifS\\xa8\\x00\\x912ZXJzaW9uD\\x00\\xa0jEuNS4zIn06\\x03\\x00\\xa4\\x03!Ah\\n\\x00\\x01`\\x03\\x01K\\x03PmP///\\x0f\\x00!QU\\xc0\\x03\\x10J \\x00\\x05\\xcb\\x030AAE\\x16\\x00\\x1fF$\\x01\\x03\\x00 \\x00\\x01@\\x00`8z///8\\xc3\\x03\\x11CU\\x00\\x10BQ\\x00\\x11A\\x0b\\x00\\x02\\x02\\x00\\x00\\x0b\\x00 Bi\\x0c\\x00@CAAM\\xd0\\x03&#34;Bw\\xd0\\x03\\x01\\x02\\x00\\x11U\\x06\\x00\\xc2QABQACAAGAAc\\xad\\x00\\x12B:\\x00\\x01\\x02\\x00\\x03\\xa0\\x00\\x12G\\r\\x00\\x01\\x06\\x00\\x01\\x02\\x00\\x00\\xa0\\x00\\x10G`\\x00\\x00p\\x001QAB\\x15\\x00\\xf1\\x02==\\x00\\x18 parquet-cpp-\\xf1\\x04\\x13 \\xd1\\x04\\x12 \\xeb\\x04R\\x19&lt;\\x1c\\x00\\x00\\x03\\x00\\xa0\\x00t\\x08\\x00\\x00PAR1\\x00\\x00\\x00\\x00\\x00&#39;
    &gt;&gt;&gt; unpack(dump)
    {&#39;a&#39;: b&#39;Some binary content&#39;, (&#39;mixed-types tuple as a key&#39;, 4): 123, &#39;df&#39;:    a  b
    x  5  1
    y  6  2
    z  7  3}
    &#34;&#34;&#34;
    if blob[:7] == b&#34;00lz4__&#34;:
        import lz4.frame as lz4

        blob = lz4.decompress(blob[7:])
    return traversal_dec(blob)


class NondeterminismException(Exception):
    pass


def serialize_numpy(obj, ensure_determinism, unsafe_fallback, prefix=b&#34;00nmpy_&#34;):
    &#34;&#34;&#34;
    &gt;&gt;&gt; from pandas import Series as S, DataFrame as DF, Series as S
    &gt;&gt;&gt; df = DF({&#34;a&#34;: [&#34;5&#34;,&#34;6&#34;,&#34;7&#34;], &#34;b&#34;: [&#34;1&#34;,&#34;2&#34;,&#34;3&#34;]}, index=[&#34;x&#34;,&#34;y&#34;,&#34;z&#34;]).to_numpy()
    &gt;&gt;&gt; serialize_numpy(df, ensure_determinism=True, unsafe_fallback=True)
    b&#39;05pckl_\\x80\\x05\\x95\\xa3\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x8c\\x15numpy.core.multiarray\\x94\\x8c\\x0c_reconstruct\\x94\\x93\\x94\\x8c\\x05numpy\\x94\\x8c\\x07ndarray\\x94\\x93\\x94K\\x00\\x85\\x94C\\x01b\\x94\\x87\\x94R\\x94(K\\x01K\\x03K\\x02\\x86\\x94h\\x03\\x8c\\x05dtype\\x94\\x93\\x94\\x8c\\x02O8\\x94\\x89\\x88\\x87\\x94R\\x94(K\\x03\\x8c\\x01|\\x94NNNJ\\xff\\xff\\xff\\xffJ\\xff\\xff\\xff\\xffK?t\\x94b\\x88]\\x94(\\x8c\\x015\\x94\\x8c\\x011\\x94\\x8c\\x016\\x94\\x8c\\x012\\x94\\x8c\\x017\\x94\\x8c\\x013\\x94et\\x94b.&#39;
    &#34;&#34;&#34;
    import numpy as np

    if isinstance(obj, np.ndarray):
        if obj.dtype in [np.dtype(object)]:
            if unsafe_fallback:
                return topickle(obj, ensure_determinism)
            raise Exception(f&#34;Please enable &#39;unsafe_fallback&#39; or handle numpy types.&#34; f&#34;Cannot handle this ndarray dtype: &#39;{obj.dtype}&#39;&#34;)
        dims = str(len(obj.shape))
        dtype = str(obj.dtype)
        rest_of_header = f&#34;§{dims}§{dtype}§&#34;.encode() + integers2bytes(obj.shape)
        rest_of_header_len = str(len(rest_of_header)).encode()
        header = rest_of_header_len + rest_of_header
        # return header + lz4.compress(ascontiguousarray(obj).data)
        return prefix + header + obj.data.tobytes()
    if unsafe_fallback:  # pragma: no cover
        return topickle(obj, ensure_determinism)
    raise Exception(f&#34;Please enable &#39;unsafe_fallback&#39;. Cannot handle this type &#39;{type(obj)}&#39;.&#34;)  # pragma: no cover


def deserialize_numpy(blob):
    import numpy as np

    rest_of_header_len = blob[:10].split(b&#34;\xc2\xa7&#34;)[0]
    first_len = len(rest_of_header_len)
    header_len = first_len + int(rest_of_header_len)
    dims, dtype, hw = blob[first_len + 2 : header_len].split(b&#34;\xc2\xa7&#34;)
    dims = int(dims.decode())
    dtype = dtype.decode().rstrip()
    shape = bytes2integers(hw.ljust(4 * dims))

    dump = memoryview(blob)[header_len:]
    # dump = lz4.decompress(dump)
    m = np.frombuffer(dump, dtype=dtype)
    if dims &gt; 1:
        m = np.reshape(m, newshape=shape)
    return m


def integers2bytes(lst, n=4) -&gt; bytes:
    &#34;&#34;&#34;Each int becomes N bytes. max=4294967294 for 4 bytes&#34;&#34;&#34;
    return b&#34;&#34;.join(d.to_bytes(n, byteorder=&#34;little&#34;) for d in lst)


def bytes2integers(bytes_content: bytes, n=4):
    &#34;&#34;&#34;Each 4 bytes become an int.&#34;&#34;&#34;
    return [int.from_bytes(bytes_content[i : i + n], &#34;little&#34;) for i in range(0, len(bytes_content), n)]


########################################################################################
########################################################################################
########################################################################################
########################################################################################


# def import_dependence(dep):
#     try:
#         return import_module(dep)
#     except ImportError as e:
#         raise Exception(f&#34;Missing {dep} library. Need a complete install\n&#34; &#34;pip install -U safeserializer[full]&#34;)


# def custom_orjson_encoder(obj):
#     # E.g., pandas dataframes.
#     typ = str(type(obj))
#     if typ == &#34;&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;&#34;:
#         return obj.to_numpy()
#     if typ == &#34;&lt;class &#39;pandas.core.series.Series&#39;&gt;&#34;:
#         return obj.to_numpy()
#     # if hasattr(obj, &#39;to_json&#39;):
#     #     # REMINDER: default_handler=str is to avoid infinite recursion, e.g., on iris.arff
#     #     txt = obj.to_json(force_ascii=False, default_handler=str)
#     #     return {&#34;_type_orjson&#34;: str(type(obj)), &#34;_obj.to_json()&#34;: txt}
#
#     # Numpy objects generic type and ndarray, keeping dtype.
#     if typ == &#34;&lt;class &#39;numpy.ndarray&#39;&gt;&#34;:
#         print(typ)
#         try:
#             return serialize_numpy(obj,ensure_determinism,unsafe_fallback) is None ???
#         except Exception as e:
#             print(e)
#             exit()
#
#     # try:
#     #     import numpy
#     #     if isinstance(obj, numpy.generic):
#     #         return {&#34;_type_orjson&#34;: str(obj.dtype), &#34;_numpy.asscalar(obj)&#34;: numpy.asscalar(obj)}
#     #     if isinstance(obj, numpy.ndarray):
#     #         return {&#34;_type_orjson&#34;: str(obj.dtype), &#34;_numpy.ndarray.tolist()&#34;: obj.tolist()}
#     # except ImportError as e:
#     #     pass
#
#     if isinstance(obj, bytes):
#         return obj.decode()  # nem qq byte vira string!
#     raise TypeError


# def json_object_hook_decoder(dic):
#     if &#34;_type_orjson&#34; in dic:
#         if &#34;_obj.to_json()&#34; in dic:
#             if dic[&#34;_type_orjson&#34;] == &#34;&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;&#34;:
#                 m = import_dependence(&#34;pandas&#34;)
#                 return m.read_json(dic[&#34;_obj.to_json()&#34;])  # , default_handler=str)
#             if dic[&#34;_type_orjson&#34;] == &#34;&lt;class &#39;pandas.core.series.Series&#39;&gt;&#34;:
#                 m = import_dependence(&#34;pandas&#34;)
#                 # default_handler=callable
#                 return m.read_json(dic[&#34;_obj.to_json()&#34;], typ=dic[&#34;_type_orjson&#34;])
#             else:  # pragma: no cover
#                 raise Exception(f&#34;Cannot desserialize object of type &#39;{dic[&#39;_type_orjson&#39;]}&#39;&#34;)
#         if (c := &#34;_numpy.asscalar(obj)&#34;) in dic or (c := &#34;_numpy.ndarray.tolist()&#34;) in dic:
#             m = import_dependence(&#34;numpy&#34;)
#             dtype = &#34;str&#34; if len(dic[&#34;_type_orjson&#34;]) &gt; 10 else dic[&#34;_type_orjson&#34;]
#             return m.array(dic[c], dtype=dtype)
#     return dic


# def serialize_json(obj):
#     # r&#34;&#34;&#34;
#     # &gt;&gt;&gt; import numpy as np
#     # &gt;&gt;&gt; import math
#     # &gt;&gt;&gt; a = np.array([[1/3, 5/4], [1.3**6, &#34;text&#34;]])
#     # &gt;&gt;&gt; a
#     # array([[&#39;0.3333333333333333&#39;, &#39;1.25&#39;],
#     #        [&#39;4.826809000000001&#39;, &#39;text&#39;]], dtype=&#39;&lt;U32&#39;)
#     # &gt;&gt;&gt; b = np.array([[1/3,5/4], [1.3**6, 4]], dtype = np.int64)
#     # &gt;&gt;&gt; b
#     # array([[0, 1],
#     #        [4, 4]])
#     # &gt;&gt;&gt; c = np.array([[1/3,5/4], [1.3**6, 4]], dtype = np.int8)
#     # &gt;&gt;&gt; c
#     # array([[0, 1],
#     #        [4, 4]], dtype=int8)
#     # &gt;&gt;&gt; serialize_json([math.inf, a, b, c])
#     # b&#39;[null,{&#34;_numpy.ndarray.tolist()&#34;:[[&#34;0.3333333333333333&#34;,&#34;1.25&#34;],[&#34;4.826809000000001&#34;,&#34;text&#34;]],&#34;_type_orjson&#34;:&#34;&lt;U32&#34;},{&#34;_numpy.ndarray.tolist()&#34;:[[0,1],[4,4]],&#34;_type_orjson&#34;:&#34;int64&#34;},{&#34;_numpy.ndarray.tolist()&#34;:[[0,1],[4,4]],&#34;_type_orjson&#34;:&#34;int8&#34;}]&#39;
#     # &gt;&gt;&gt; import pandas as pd
#     # &gt;&gt;&gt; df = pd.DataFrame(
#     # ...     [[1/3, 5/4], [1.3**54, &#34;text&#34;]],
#     # ...     index=[&#34;row 1&#34;, &#34;row 2&#34;],
#     # ...     columns=[&#34;col 1&#34;, &#34;col 2&#34;],
#     # ... )
#     # &gt;&gt;&gt; df
#     #               col 1 col 2
#     # row 1  3.333333e-01  1.25
#     # row 2  1.422136e+06  text
#     # &gt;&gt;&gt; serialize_json(df)
#     # b&#39;{&#34;_obj.to_json()&#34;:&#34;{\\&#34;col 1\\&#34;:{\\&#34;row 1\\&#34;:0.3333333333,\\&#34;row 2\\&#34;:1422135.6537506874},\\&#34;col 2\\&#34;:{\\&#34;row 1\\&#34;:1.25,\\&#34;row 2\\&#34;:\\&#34;text\\&#34;}}&#34;,&#34;_type_orjson&#34;:&#34;&lt;class \&#39;pandas.core.frame.DataFrame\&#39;&gt;&#34;}&#39;
#     # &gt;&gt;&gt; s = pd.Series(
#     # ...     [1/3, 5/4, (1.3)**54, &#34;text&#34;],
#     # ...     index=[&#34;row 1&#34;, &#34;row 2&#34;, &#34;row 3&#34;, &#34;row 4&#34;],
#     # ... )
#     # &gt;&gt;&gt; s
#     # row 1          0.333333
#     # row 2              1.25
#     # row 3    1422135.653751
#     # row 4              text
#     # dtype: object
#     # &gt;&gt;&gt; serialize_json(s)
#     # b&#39;{&#34;_obj.to_json()&#34;:&#34;{\\&#34;row 1\\&#34;:0.3333333333,\\&#34;row 2\\&#34;:1.25,\\&#34;row 3\\&#34;:1422135.6537506874,\\&#34;row 4\\&#34;:\\&#34;text\\&#34;}&#34;,&#34;_type_orjson&#34;:&#34;&lt;class \&#39;pandas.core.series.Series\&#39;&gt;&#34;}&#39;
#     # &#34;&#34;&#34;
#     return dumps(obj, default=custom_orjson_encoder, option=OPT_SORT_KEYS)


# def deserialize_json(blob):
#     return json.loads(blob, object_hook=json_object_hook_decoder)</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-functions">Functions</h2>
<dl>
<dt id="safeserializer.compression.bytes2integers"><code class="name flex">
<span>def <span class="ident">bytes2integers</span></span>(<span>bytes_content: bytes, n=4)</span>
</code></dt>
<dd>
<div class="desc"><p>Each 4 bytes become an int.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def bytes2integers(bytes_content: bytes, n=4):
    &#34;&#34;&#34;Each 4 bytes become an int.&#34;&#34;&#34;
    return [int.from_bytes(bytes_content[i : i + n], &#34;little&#34;) for i in range(0, len(bytes_content), n)]</code></pre>
</details>
</dd>
<dt id="safeserializer.compression.deserialize_numpy"><code class="name flex">
<span>def <span class="ident">deserialize_numpy</span></span>(<span>blob)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def deserialize_numpy(blob):
    import numpy as np

    rest_of_header_len = blob[:10].split(b&#34;\xc2\xa7&#34;)[0]
    first_len = len(rest_of_header_len)
    header_len = first_len + int(rest_of_header_len)
    dims, dtype, hw = blob[first_len + 2 : header_len].split(b&#34;\xc2\xa7&#34;)
    dims = int(dims.decode())
    dtype = dtype.decode().rstrip()
    shape = bytes2integers(hw.ljust(4 * dims))

    dump = memoryview(blob)[header_len:]
    # dump = lz4.decompress(dump)
    m = np.frombuffer(dump, dtype=dtype)
    if dims &gt; 1:
        m = np.reshape(m, newshape=shape)
    return m</code></pre>
</details>
</dd>
<dt id="safeserializer.compression.frompickle"><code class="name flex">
<span>def <span class="ident">frompickle</span></span>(<span>blob)</span>
</code></dt>
<dd>
<div class="desc"><pre><code class="language-python-repl">&gt;&gt;&gt; du = frompickle(b'05pckl_\x80\x05\x95#\x00\x00\x00\x00\x00\x00\x00}\x94\x8c\x01a\x94]\x94(K\x03\x8c\x08builtins\x94\x8c\x05print\x94\x93\x94es.')
&gt;&gt;&gt; du[&quot;a&quot;][1]() is None
&lt;BLANKLINE&gt;
True
</code></pre></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def frompickle(blob):
    &#34;&#34;&#34;
    &gt;&gt;&gt; du = frompickle(b&#39;05pckl_\\x80\\x05\\x95#\\x00\\x00\\x00\\x00\\x00\\x00\\x00}\\x94\\x8c\\x01a\\x94]\\x94(K\\x03\\x8c\\x08builtins\\x94\\x8c\\x05print\\x94\\x93\\x94es.&#39;)
    &gt;&gt;&gt; du[&#34;a&#34;][1]() is None
    &lt;BLANKLINE&gt;
    True
    &#34;&#34;&#34;
    prefix = blob[:7]
    blob = blob[7:]
    if prefix == b&#34;05pckl_&#34;:
        return pickle.loads(blob)
    elif prefix == b&#34;05dill_&#34;:  # pragma: no cover
        import dill

        return dill.loads(blob)</code></pre>
</details>
</dd>
<dt id="safeserializer.compression.integers2bytes"><code class="name flex">
<span>def <span class="ident">integers2bytes</span></span>(<span>lst, n=4) ‑> bytes</span>
</code></dt>
<dd>
<div class="desc"><p>Each int becomes N bytes. max=4294967294 for 4 bytes</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def integers2bytes(lst, n=4) -&gt; bytes:
    &#34;&#34;&#34;Each int becomes N bytes. max=4294967294 for 4 bytes&#34;&#34;&#34;
    return b&#34;&#34;.join(d.to_bytes(n, byteorder=&#34;little&#34;) for d in lst)</code></pre>
</details>
</dd>
<dt id="safeserializer.compression.pack"><code class="name flex">
<span>def <span class="ident">pack</span></span>(<span>obj, ensure_determinism, unsafe_fallback, compressed=True)</span>
</code></dt>
<dd>
<div class="desc"><p>Serialize 'obj' to bytes.</p>
<p>Attempt to serialize using one of the following options, in this order:
orjson
bson
bigints as str
numpy ndarray as raw bytes
pandas numeric Series/DataFrame as ndarray raw bytes
pandas ill-behaved Series/DataFrame as parquet
pickle when 'unsafe_fallback=True'
dill when 'ensure_determinism=False'.</p>
<pre><code class="language-python-repl">&gt;&gt;&gt; import numpy as np
&gt;&gt;&gt; d = [[np.array([[1, 2/3], [4, 5]]), {&quot;x&quot;: b&quot;dsa&quot;}], [b&quot;asd&quot;, 5]]
&gt;&gt;&gt; blob = pack(d, ensure_determinism=True, unsafe_fallback=False)
&gt;&gt;&gt; unpack(blob)
[[array([[1.        , 0.66666667],
       [4.        , 5.        ]]), {'x': b'dsa'}], [b'asd', 5]]
&gt;&gt;&gt; blob = pack(d, ensure_determinism=True, unsafe_fallback=False, compressed=False)
&gt;&gt;&gt; unpack(blob)
[[array([[1.        , 0.66666667],
       [4.        , 5.        ]]), {'x': b'dsa'}], [b'asd', 5]]
&gt;&gt;&gt; import pandas as pd
&gt;&gt;&gt; df = pd.DataFrame(np.array([[1, 2/3], [4, 5]]))
&gt;&gt;&gt; unpack(pack(df, ensure_determinism=True, unsafe_fallback=False))
     0         1
0  1.0  0.666667
1  4.0  5.000000
</code></pre>
<pre><code class="language-python-repl">&gt;&gt;&gt; unpack(pack({&quot;0&quot;: 3, &quot;b&quot;: print}, ensure_determinism=True, unsafe_fallback=True, compressed=False))
{'0': 3, 'b': &lt;built-in function print&gt;}
&gt;&gt;&gt; unpack(pack({&quot;0&quot;: 3, &quot;b&quot;: b&quot;b&quot;}, ensure_determinism=True, unsafe_fallback=False, compressed=False))
{'0': 3, 'b': b'b'}
</code></pre></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def pack(obj, ensure_determinism, unsafe_fallback, compressed=True):
    r&#34;&#34;&#34;
    Serialize &#39;obj&#39; to bytes.

    Attempt to serialize using one of the following options, in this order:
        orjson
        bson
        bigints as str
        numpy ndarray as raw bytes
        pandas numeric Series/DataFrame as ndarray raw bytes
        pandas ill-behaved Series/DataFrame as parquet
        pickle when &#39;unsafe_fallback=True&#39;
        dill when &#39;ensure_determinism=False&#39;.

    &gt;&gt;&gt; import numpy as np
    &gt;&gt;&gt; d = [[np.array([[1, 2/3], [4, 5]]), {&#34;x&#34;: b&#34;dsa&#34;}], [b&#34;asd&#34;, 5]]
    &gt;&gt;&gt; blob = pack(d, ensure_determinism=True, unsafe_fallback=False)
    &gt;&gt;&gt; unpack(blob)
    [[array([[1.        , 0.66666667],
           [4.        , 5.        ]]), {&#39;x&#39;: b&#39;dsa&#39;}], [b&#39;asd&#39;, 5]]
    &gt;&gt;&gt; blob = pack(d, ensure_determinism=True, unsafe_fallback=False, compressed=False)
    &gt;&gt;&gt; unpack(blob)
    [[array([[1.        , 0.66666667],
           [4.        , 5.        ]]), {&#39;x&#39;: b&#39;dsa&#39;}], [b&#39;asd&#39;, 5]]
    &gt;&gt;&gt; import pandas as pd
    &gt;&gt;&gt; df = pd.DataFrame(np.array([[1, 2/3], [4, 5]]))
    &gt;&gt;&gt; unpack(pack(df, ensure_determinism=True, unsafe_fallback=False))
         0         1
    0  1.0  0.666667
    1  4.0  5.000000

    &gt;&gt;&gt; unpack(pack({&#34;0&#34;: 3, &#34;b&#34;: print}, ensure_determinism=True, unsafe_fallback=True, compressed=False))
    {&#39;0&#39;: 3, &#39;b&#39;: &lt;built-in function print&gt;}
    &gt;&gt;&gt; unpack(pack({&#34;0&#34;: 3, &#34;b&#34;: b&#34;b&#34;}, ensure_determinism=True, unsafe_fallback=False, compressed=False))
    {&#39;0&#39;: 3, &#39;b&#39;: b&#39;b&#39;}
    &#34;&#34;&#34;
    dump = traversal_enc(obj, ensure_determinism, unsafe_fallback)
    if compressed:
        import lz4.frame as lz4

        return b&#34;00lz4__&#34; + lz4.compress(dump)
    return dump</code></pre>
</details>
</dd>
<dt id="safeserializer.compression.serialize_numpy"><code class="name flex">
<span>def <span class="ident">serialize_numpy</span></span>(<span>obj, ensure_determinism, unsafe_fallback, prefix=b'00nmpy_')</span>
</code></dt>
<dd>
<div class="desc"><pre><code class="language-python-repl">&gt;&gt;&gt; from pandas import Series as S, DataFrame as DF, Series as S
&gt;&gt;&gt; df = DF({&quot;a&quot;: [&quot;5&quot;,&quot;6&quot;,&quot;7&quot;], &quot;b&quot;: [&quot;1&quot;,&quot;2&quot;,&quot;3&quot;]}, index=[&quot;x&quot;,&quot;y&quot;,&quot;z&quot;]).to_numpy()
&gt;&gt;&gt; serialize_numpy(df, ensure_determinism=True, unsafe_fallback=True)
b'05pckl_\x80\x05\x95\xa3\x00\x00\x00\x00\x00\x00\x00\x8c\x15numpy.core.multiarray\x94\x8c\x0c_reconstruct\x94\x93\x94\x8c\x05numpy\x94\x8c\x07ndarray\x94\x93\x94K\x00\x85\x94C\x01b\x94\x87\x94R\x94(K\x01K\x03K\x02\x86\x94h\x03\x8c\x05dtype\x94\x93\x94\x8c\x02O8\x94\x89\x88\x87\x94R\x94(K\x03\x8c\x01|\x94NNNJ\xff\xff\xff\xffJ\xff\xff\xff\xffK?t\x94b\x88]\x94(\x8c\x015\x94\x8c\x011\x94\x8c\x016\x94\x8c\x012\x94\x8c\x017\x94\x8c\x013\x94et\x94b.'
</code></pre></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def serialize_numpy(obj, ensure_determinism, unsafe_fallback, prefix=b&#34;00nmpy_&#34;):
    &#34;&#34;&#34;
    &gt;&gt;&gt; from pandas import Series as S, DataFrame as DF, Series as S
    &gt;&gt;&gt; df = DF({&#34;a&#34;: [&#34;5&#34;,&#34;6&#34;,&#34;7&#34;], &#34;b&#34;: [&#34;1&#34;,&#34;2&#34;,&#34;3&#34;]}, index=[&#34;x&#34;,&#34;y&#34;,&#34;z&#34;]).to_numpy()
    &gt;&gt;&gt; serialize_numpy(df, ensure_determinism=True, unsafe_fallback=True)
    b&#39;05pckl_\\x80\\x05\\x95\\xa3\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x8c\\x15numpy.core.multiarray\\x94\\x8c\\x0c_reconstruct\\x94\\x93\\x94\\x8c\\x05numpy\\x94\\x8c\\x07ndarray\\x94\\x93\\x94K\\x00\\x85\\x94C\\x01b\\x94\\x87\\x94R\\x94(K\\x01K\\x03K\\x02\\x86\\x94h\\x03\\x8c\\x05dtype\\x94\\x93\\x94\\x8c\\x02O8\\x94\\x89\\x88\\x87\\x94R\\x94(K\\x03\\x8c\\x01|\\x94NNNJ\\xff\\xff\\xff\\xffJ\\xff\\xff\\xff\\xffK?t\\x94b\\x88]\\x94(\\x8c\\x015\\x94\\x8c\\x011\\x94\\x8c\\x016\\x94\\x8c\\x012\\x94\\x8c\\x017\\x94\\x8c\\x013\\x94et\\x94b.&#39;
    &#34;&#34;&#34;
    import numpy as np

    if isinstance(obj, np.ndarray):
        if obj.dtype in [np.dtype(object)]:
            if unsafe_fallback:
                return topickle(obj, ensure_determinism)
            raise Exception(f&#34;Please enable &#39;unsafe_fallback&#39; or handle numpy types.&#34; f&#34;Cannot handle this ndarray dtype: &#39;{obj.dtype}&#39;&#34;)
        dims = str(len(obj.shape))
        dtype = str(obj.dtype)
        rest_of_header = f&#34;§{dims}§{dtype}§&#34;.encode() + integers2bytes(obj.shape)
        rest_of_header_len = str(len(rest_of_header)).encode()
        header = rest_of_header_len + rest_of_header
        # return header + lz4.compress(ascontiguousarray(obj).data)
        return prefix + header + obj.data.tobytes()
    if unsafe_fallback:  # pragma: no cover
        return topickle(obj, ensure_determinism)
    raise Exception(f&#34;Please enable &#39;unsafe_fallback&#39;. Cannot handle this type &#39;{type(obj)}&#39;.&#34;)  # pragma: no cover</code></pre>
</details>
</dd>
<dt id="safeserializer.compression.topickle"><code class="name flex">
<span>def <span class="ident">topickle</span></span>(<span>obj, ensure_determinism)</span>
</code></dt>
<dd>
<div class="desc"><pre><code class="language-python-repl">&gt;&gt;&gt; f = print
&gt;&gt;&gt; du = topickle({&quot;a&quot;: [3, f]}, ensure_determinism=False)
&gt;&gt;&gt; res = frompickle(du)
&gt;&gt;&gt; res[&quot;a&quot;][1]() is None
&lt;BLANKLINE&gt;
True
&gt;&gt;&gt; frompickle(topickle({&quot;a&quot;: [3, None]}, ensure_determinism=True))
{'a': [3, None]}
</code></pre></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def topickle(obj, ensure_determinism):
    &#34;&#34;&#34;
    &gt;&gt;&gt; f = print
    &gt;&gt;&gt; du = topickle({&#34;a&#34;: [3, f]}, ensure_determinism=False)
    &gt;&gt;&gt; res = frompickle(du)
    &gt;&gt;&gt; res[&#34;a&#34;][1]() is None
    &lt;BLANKLINE&gt;
    True
    &gt;&gt;&gt; frompickle(topickle({&#34;a&#34;: [3, None]}, ensure_determinism=True))
    {&#39;a&#39;: [3, None]}
    &#34;&#34;&#34;
    try:
        prefix = b&#34;05pckl_&#34;
        dump = pickle.dumps(obj, protocol=5)
    except Exception as e:  # pragma: no cover
        if ensure_determinism:
            print(e)
            raise NondeterminismException(&#34;Cannot serialize deterministically.&#34;)
        import dill

        try:
            prefix = b&#34;05dill_&#34;
            dump = dill.dumps(obj, protocol=5)
        except KeyError as e:
            if str(e) == &#34;&#39;__getstate__&#39;&#34;:
                raise Exception(&#34;Unpickable value:&#34;, type(obj))
            else:
                raise e
    blob = prefix + dump
    return blob</code></pre>
</details>
</dd>
<dt id="safeserializer.compression.traversal_dec"><code class="name flex">
<span>def <span class="ident">traversal_dec</span></span>(<span>dump)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def traversal_dec(dump):
    if isinstance(dump, bytes):
        header = dump[2:7]
        blob = dump[7:]
        if header == b&#34;json_&#34;:
            return orjson.loads(blob)
        if header == b&#34;bson_&#34;:
            return bson.decode(blob)[&#34;_&#34;]
        if header == b&#34;bint_&#34;:
            return int(blob.decode())
        if header == b&#34;nmpy_&#34;:
            return deserialize_numpy(blob)
        if header == b&#34;prqs_&#34;:
            import pandas as pd
            from io import BytesIO

            obj = pd.read_parquet(BytesIO(blob)).squeeze()
            if obj.name == &#34;_none_&#34;:
                obj.rename(None, inplace=True)
            return obj
        if header == b&#34;bsos_&#34;:
            from pandas import Series

            dec = bson.decode(blob)
            obj = deserialize_numpy(dec[&#34;v&#34;])
            kwargs = {&#34;name&#34;: dec[&#34;n&#34;]} if &#34;n&#34; in dec else {}
            return Series(obj, dec[&#34;i&#34;], **kwargs)
        if header == b&#34;prqd_&#34;:
            import pandas as pd
            from io import BytesIO

            return pd.read_parquet(BytesIO(blob))
        if header == b&#34;npdf_&#34;:
            from pandas import DataFrame

            return DataFrame(deserialize_numpy(blob))
        if header == b&#34;list_&#34;:
            return traversal_dec(bson.decode(blob)[&#34;_&#34;])
        if header == b&#34;tupl_&#34;:
            return traversal_dec(tuple(bson.decode(blob)[&#34;_&#34;]))
        if header == b&#34;dict_&#34;:
            return traversal_dec(bson.decode(blob))
        if header == b&#34;dicB_&#34;:
            decoded = bson.decode(blob).items()
            return {traversal_dec(unhexlify(k.encode(&#34;utf-8&#34;))): traversal_dec(v) for k, v in decoded}
        if header in [b&#34;pckl_&#34;, b&#34;dill_&#34;]:
            return frompickle(dump)
        return dump
    # if isinstance(dump, (int, str, bool)):
    #     return dump
    if isinstance(dump, tuple):
        return tuple(traversal_dec(d) for d in dump)
    if isinstance(dump, list):
        return [traversal_dec(d) for d in dump]
    if isinstance(dump, dict):
        return {k: traversal_dec(v) for k, v in dump.items()}
    raise Exception(f&#34;Cannot unpack {type(dump)}.&#34;)  # pragma: no cover</code></pre>
</details>
</dd>
<dt id="safeserializer.compression.traversal_enc"><code class="name flex">
<span>def <span class="ident">traversal_enc</span></span>(<span>obj, ensure_determinism, unsafe_fallback)</span>
</code></dt>
<dd>
<div class="desc"><p>TODO: Fix nested tuples being converted to lists by json?
'tuple' should make orjson/bson raise an exception like it would happen for hditc,
it would be easy to handle like with other non built-in types.</p>
<pre><code class="language-python-repl">&gt;&gt;&gt; unpack(pack([&quot;a&quot;, [&quot;3&quot;, 4], &quot;b&quot;, 4], ensure_determinism=False, unsafe_fallback=False))
['a', ['3', 4], 'b', 4]
&gt;&gt;&gt; unpack(pack([{0: [{&quot;3&quot;:4}], &quot;b&quot;: b&quot;b&quot;}], ensure_determinism=False, unsafe_fallback=False))
[{0: [{'3': 4}], 'b': b'b'}]
&gt;&gt;&gt; du = pack(True, ensure_determinism=False, unsafe_fallback=True, compressed=False)
&gt;&gt;&gt; du
b'00json_true'
&gt;&gt;&gt; unpack(du)
True
&gt;&gt;&gt; unpack(pack([True], ensure_determinism=False, unsafe_fallback=True, compressed=False))
[True]
&gt;&gt;&gt; unpack(pack([{&quot;a&quot;: b&quot;some bytes&quot;, &quot;b&quot;:print}], ensure_determinism=False, unsafe_fallback=True))[0][&quot;a&quot;]
b'some bytes'
&gt;&gt;&gt; unpack(pack(b&quot;some bytes&quot;, ensure_determinism=False, unsafe_fallback=True))
b'some bytes'
&gt;&gt;&gt; unpack(pack(99999999999999999999999999999999999999999, ensure_determinism=False, unsafe_fallback=True))
99999999999999999999999999999999999999999
&gt;&gt;&gt; from pandas import Series as S, DataFrame as DF
&gt;&gt;&gt; s = S({&quot;a&quot;: 5, &quot;b&quot;: 6}, name=&quot;column&quot;)
&gt;&gt;&gt; a = pack(s, ensure_determinism=True, unsafe_fallback=False)
&gt;&gt;&gt; a  # doctest: +SKIP
b'00lz4__\x04&quot;M\x18h@^\x00\x00\x00\x00\x00\x00\x00@\\\x00\x00\x00\xf1\x0e00bsos_W\x00\x00\x00\x04i\x00\x17\x00\x00\x00\x020\x00\x02\x00\x00\x00a\x00\x021\t\x00\xf0\nb\x00\x00\x05v\x00&quot;\x00\x00\x00\x0016\xc2\xa71\xc2\xa7int64\xc2\xa7&amp;\x00\x10\x05\x17\x00A\x00\x00\x00\x06\x06\x00\xf0\x02\x00\x00\x02n\x00\x07\x00\x00\x00column\x00\x00\x00\x00\x00\x00'
&gt;&gt;&gt; unpack(a)
a    5
b    6
Name: column, dtype: int64
&gt;&gt;&gt; s = S({&quot;a&quot;: &quot;5&quot;, &quot;b&quot;: &quot;6&quot;})
&gt;&gt;&gt; b = pack(s, ensure_determinism=True, unsafe_fallback=False)
&gt;&gt;&gt; b
b'00lz4__\x04&quot;M\x18h@\x1d\x08\x00\x00\x00\x00\x00\x00\xec\xe2\x04\x00\x00\xf0\x1100prqs_PAR1\x15\x04\x15\x14\x15\x18L\x15\x04\x15\x00\x12\x00\x00\n$\x01\x00\x00\x005\x05\x00\xf696\x15\x00\x15\x12\x15\x16,\x15\x04\x15\x10\x15\x06\x15\x06\x1c6\x00(\x016\x18\x015\x00\x00\x00\t \x02\x00\x00\x00\x04\x01\x01\x03\x02&amp;\x88\x01\x1c\x15\x0c\x195\x10\x00\x06\x19\x18\x06_none_\x15\x02\x16\x04\x16x\x16\x80\x01&amp;&lt;&amp;\x088\x00\x10\x19L\x00\x90\x00\x15\x02\x00\x15\x00\x15\x10\x15B\x00\x0f}\x00\x01\x10a}\x00\x1fb}\x00\x01Kb\x18\x01a}\x00&amp;\x82\x03}\x00\xf7\x02\x11__index_level_0_\x88\x00Q\xb6\x02&amp;\x82\x02\x8a\x00\x01E\x00\x0f\x8a\x00\x01\xf4\x04\x19&lt;5\x00\x18\x06schema\x15\x04\x00\x15\x0c%\x02\xd0\x00b%\x00L\x1c\x00\x00\x13\x00\x0ef\x00\x03\x1e\x00o\x16\x04\x19\x1c\x19,\x0f\x01*\x0f\xcf\x007\xf2\r\x16\xf0\x01\x16\x04&amp;\x08\x16\x80\x02\x14\x00\x00\x19,\x18\x06pandas\x18\xfc\x03{&quot;%\x01\xcdcolumns&quot;: [&quot;9\x01R&quot;], &quot;&quot;\x00\x02T\x01\x11e)\x00\xfa\x07{&quot;name&quot;: null, &quot;field_\x14\x00\x02i\x00@_typ)\x00\xf5\x02&quot;unicode&quot;, &quot;numpy\x19\x00`object\x18\x00\xf6\x12metadata&quot;: {&quot;encoding&quot;: &quot;UTF-8&quot;}}\x8d\x00\n\x86\x00\x12&quot;n\x02\x00D\x00\t\x8a\x00\x07\x18\x00\x0f\x8e\x00*\x00\xe6\x00?}, \xf6\x00\n\x0f&lt;\x01\x00\x0fw\x002\x01\xf4\x00areator\x18\x01plibrary\x17\x01ppyarrow\xf7\x00pversion\x16\x00\x8611.0.0&quot;}~\x00\x08\x1d\x00\xf2\x00.5.3&quot;}\x00\x18\x0cARROW:\xe6\x02@\x18\xe0\x07/\x01\x00\x82+ACAAAQA\x01\x00\xf1\x00KAA4ABgAFAAgACg\x15\x00)BB \x00\x10w\x15\x00\x15E \x00 DQ@\x00\x10E\x15\x00\x02F\x00\x01 \x00\x10I\x08\x00\x11B\x08\x00\x01E\x00\x10I \x00\x02%\x00\xf4FYAAABwYW5kYXMAAPwBAAB7ImluZGV4X2NvbHVtbnMiOiBbIl9faW5kZXhfbGV2ZWxfMF9fIl0sICJjb2x1bW5$\x00\xf0\x01lcyI6IFt7Im5hbWUD\x00\xf3\x15udWxsLCAiZmllbGRfbmFtZSI6IG51bGwsICJ\x90\x00aNfdHlw\x1c\x00\xf0\x0eCJ1bmljb2RlIiwgIm51bXB5X3R5cGX\x00\xa2Aib2JqZWN0 \x00\xf0\x0c1ldGFkYXRhIjogeyJlbmNvZGluZ\x94\x00\xd9CJVVEYtOCJ9fV\xbc\x00\x10z0\x00EW3si\x98\x00\xbfCJfbm9uZV8i\xb8\x00\x02\x0b \x00\x88cGFuZGFz\x9c\x00\xb0dW5pY29kZSI\xe0\x00\xd0udW1weV90eXBlp\x00\xa1Im9iamVjdC \x00\xa5tZXRhZGF0Y\x18\x01@x9LC\x98\x01\x0fH\x01\x10TCJfX2\xc0\x01\xc1xldmVsXzBfXy\\\x00\x0f\\\x01&gt;\x80bnVsbH1d\x1c\x01\xf0\nY3JlYXRvciI6IHsibGlicmFye\xc8\x00\xb1CJweWFycm93\xa4\x01\xa1nZlcnNpb24\xc0\x01\xa1MTEuMC4wIn\x90\x01\x06\xa8\x00\x80mVyc2lvbT\x00\xb0CIxLjUuMyJ9\xc4\x02\x02\xcb\x02 BM\n\x00\x10B\x05\x00\xb1Mz///8AAAEF\xe0\x02\x11CK\x03\x01\x0b\x00\x01\x02\x00\x10B\x0b\x00\x1fB \x01\x03`wAAAMj@\x00@QABQ\x89\x03`GAAcAD9\x00\x17BE\x00!QUU\x00\x10H\x18\x00\x02e\x03\x01\x02\x00\x10B[\x03\x94F9ub25lXw3\x00\x01+\x00\x01\x02\x00\xf1\x00\x00\x18 parquet-cpp-9\x04\x13 \x19\x04\x12 3\x04P\x19,\x1c\x00\x00\xdf\x06\x80\x03\x07\x00\x00PAR1\x00\x00\x00\x00'
&gt;&gt;&gt; unpack(b)
a    5
b    6
dtype: object
&gt;&gt;&gt; s = S({&quot;a&quot;: &quot;5&quot;, &quot;b&quot;: 6}, name=&quot;column&quot;)
&gt;&gt;&gt; unpack(pack(s, ensure_determinism=True, unsafe_fallback=True))
a    5
b    6
Name: column, dtype: object
&gt;&gt;&gt; df = DF({&quot;a&quot;: [&quot;5&quot;,&quot;6&quot;,&quot;7&quot;], &quot;b&quot;: [1,2,3]}, index=[&quot;x&quot;,&quot;y&quot;,&quot;z&quot;])
&gt;&gt;&gt; unpack(pack(df, ensure_determinism=True, unsafe_fallback=False))
   a  b
x  5  1
y  6  2
z  7  3
&gt;&gt;&gt; df = DF({&quot;a&quot;: [&quot;5&quot;,6,&quot;7&quot;], &quot;b&quot;: [&quot;1&quot;,&quot;2&quot;,&quot;3&quot;]}, index=[&quot;x&quot;,&quot;y&quot;,&quot;z&quot;])
&gt;&gt;&gt; unpack(pack(df, ensure_determinism=True, unsafe_fallback=True))
   a  b
x  5  1
y  6  2
z  7  3
</code></pre></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def traversal_enc(obj, ensure_determinism, unsafe_fallback):
    &#34;&#34;&#34;
    TODO: Fix nested tuples being converted to lists by json?
        &#39;tuple&#39; should make orjson/bson raise an exception like it would happen for hditc,
        it would be easy to handle like with other non built-in types.
    &gt;&gt;&gt; unpack(pack([&#34;a&#34;, [&#34;3&#34;, 4], &#34;b&#34;, 4], ensure_determinism=False, unsafe_fallback=False))
    [&#39;a&#39;, [&#39;3&#39;, 4], &#39;b&#39;, 4]
    &gt;&gt;&gt; unpack(pack([{0: [{&#34;3&#34;:4}], &#34;b&#34;: b&#34;b&#34;}], ensure_determinism=False, unsafe_fallback=False))
    [{0: [{&#39;3&#39;: 4}], &#39;b&#39;: b&#39;b&#39;}]
    &gt;&gt;&gt; du = pack(True, ensure_determinism=False, unsafe_fallback=True, compressed=False)
    &gt;&gt;&gt; du
    b&#39;00json_true&#39;
    &gt;&gt;&gt; unpack(du)
    True
    &gt;&gt;&gt; unpack(pack([True], ensure_determinism=False, unsafe_fallback=True, compressed=False))
    [True]
    &gt;&gt;&gt; unpack(pack([{&#34;a&#34;: b&#34;some bytes&#34;, &#34;b&#34;:print}], ensure_determinism=False, unsafe_fallback=True))[0][&#34;a&#34;]
    b&#39;some bytes&#39;
    &gt;&gt;&gt; unpack(pack(b&#34;some bytes&#34;, ensure_determinism=False, unsafe_fallback=True))
    b&#39;some bytes&#39;
    &gt;&gt;&gt; unpack(pack(99999999999999999999999999999999999999999, ensure_determinism=False, unsafe_fallback=True))
    99999999999999999999999999999999999999999
    &gt;&gt;&gt; from pandas import Series as S, DataFrame as DF
    &gt;&gt;&gt; s = S({&#34;a&#34;: 5, &#34;b&#34;: 6}, name=&#34;column&#34;)
    &gt;&gt;&gt; a = pack(s, ensure_determinism=True, unsafe_fallback=False)
    &gt;&gt;&gt; a  # doctest: +SKIP
    b&#39;00lz4__\\x04&#34;M\\x18h@^\\x00\\x00\\x00\\x00\\x00\\x00\\x00@\\\\\\x00\\x00\\x00\\xf1\\x0e00bsos_W\\x00\\x00\\x00\\x04i\\x00\\x17\\x00\\x00\\x00\\x020\\x00\\x02\\x00\\x00\\x00a\\x00\\x021\\t\\x00\\xf0\\nb\\x00\\x00\\x05v\\x00&#34;\\x00\\x00\\x00\\x0016\\xc2\\xa71\\xc2\\xa7int64\\xc2\\xa7&amp;\\x00\\x10\\x05\\x17\\x00A\\x00\\x00\\x00\\x06\\x06\\x00\\xf0\\x02\\x00\\x00\\x02n\\x00\\x07\\x00\\x00\\x00column\\x00\\x00\\x00\\x00\\x00\\x00&#39;
    &gt;&gt;&gt; unpack(a)
    a    5
    b    6
    Name: column, dtype: int64
    &gt;&gt;&gt; s = S({&#34;a&#34;: &#34;5&#34;, &#34;b&#34;: &#34;6&#34;})
    &gt;&gt;&gt; b = pack(s, ensure_determinism=True, unsafe_fallback=False)
    &gt;&gt;&gt; b
    b&#39;00lz4__\\x04&#34;M\\x18h@\\x1d\\x08\\x00\\x00\\x00\\x00\\x00\\x00\\xec\\xe2\\x04\\x00\\x00\\xf0\\x1100prqs_PAR1\\x15\\x04\\x15\\x14\\x15\\x18L\\x15\\x04\\x15\\x00\\x12\\x00\\x00\\n$\\x01\\x00\\x00\\x005\\x05\\x00\\xf696\\x15\\x00\\x15\\x12\\x15\\x16,\\x15\\x04\\x15\\x10\\x15\\x06\\x15\\x06\\x1c6\\x00(\\x016\\x18\\x015\\x00\\x00\\x00\\t \\x02\\x00\\x00\\x00\\x04\\x01\\x01\\x03\\x02&amp;\\x88\\x01\\x1c\\x15\\x0c\\x195\\x10\\x00\\x06\\x19\\x18\\x06_none_\\x15\\x02\\x16\\x04\\x16x\\x16\\x80\\x01&amp;&lt;&amp;\\x088\\x00\\x10\\x19L\\x00\\x90\\x00\\x15\\x02\\x00\\x15\\x00\\x15\\x10\\x15B\\x00\\x0f}\\x00\\x01\\x10a}\\x00\\x1fb}\\x00\\x01Kb\\x18\\x01a}\\x00&amp;\\x82\\x03}\\x00\\xf7\\x02\\x11__index_level_0_\\x88\\x00Q\\xb6\\x02&amp;\\x82\\x02\\x8a\\x00\\x01E\\x00\\x0f\\x8a\\x00\\x01\\xf4\\x04\\x19&lt;5\\x00\\x18\\x06schema\\x15\\x04\\x00\\x15\\x0c%\\x02\\xd0\\x00b%\\x00L\\x1c\\x00\\x00\\x13\\x00\\x0ef\\x00\\x03\\x1e\\x00o\\x16\\x04\\x19\\x1c\\x19,\\x0f\\x01*\\x0f\\xcf\\x007\\xf2\\r\\x16\\xf0\\x01\\x16\\x04&amp;\\x08\\x16\\x80\\x02\\x14\\x00\\x00\\x19,\\x18\\x06pandas\\x18\\xfc\\x03{&#34;%\\x01\\xcdcolumns&#34;: [&#34;9\\x01R&#34;], &#34;&#34;\\x00\\x02T\\x01\\x11e)\\x00\\xfa\\x07{&#34;name&#34;: null, &#34;field_\\x14\\x00\\x02i\\x00@_typ)\\x00\\xf5\\x02&#34;unicode&#34;, &#34;numpy\\x19\\x00`object\\x18\\x00\\xf6\\x12metadata&#34;: {&#34;encoding&#34;: &#34;UTF-8&#34;}}\\x8d\\x00\\n\\x86\\x00\\x12&#34;n\\x02\\x00D\\x00\\t\\x8a\\x00\\x07\\x18\\x00\\x0f\\x8e\\x00*\\x00\\xe6\\x00?}, \\xf6\\x00\\n\\x0f&lt;\\x01\\x00\\x0fw\\x002\\x01\\xf4\\x00areator\\x18\\x01plibrary\\x17\\x01ppyarrow\\xf7\\x00pversion\\x16\\x00\\x8611.0.0&#34;}~\\x00\\x08\\x1d\\x00\\xf2\\x00.5.3&#34;}\\x00\\x18\\x0cARROW:\\xe6\\x02@\\x18\\xe0\\x07/\\x01\\x00\\x82+ACAAAQA\\x01\\x00\\xf1\\x00KAA4ABgAFAAgACg\\x15\\x00)BB \\x00\\x10w\\x15\\x00\\x15E \\x00 DQ@\\x00\\x10E\\x15\\x00\\x02F\\x00\\x01 \\x00\\x10I\\x08\\x00\\x11B\\x08\\x00\\x01E\\x00\\x10I \\x00\\x02%\\x00\\xf4FYAAABwYW5kYXMAAPwBAAB7ImluZGV4X2NvbHVtbnMiOiBbIl9faW5kZXhfbGV2ZWxfMF9fIl0sICJjb2x1bW5$\\x00\\xf0\\x01lcyI6IFt7Im5hbWUD\\x00\\xf3\\x15udWxsLCAiZmllbGRfbmFtZSI6IG51bGwsICJ\\x90\\x00aNfdHlw\\x1c\\x00\\xf0\\x0eCJ1bmljb2RlIiwgIm51bXB5X3R5cGX\\x00\\xa2Aib2JqZWN0 \\x00\\xf0\\x0c1ldGFkYXRhIjogeyJlbmNvZGluZ\\x94\\x00\\xd9CJVVEYtOCJ9fV\\xbc\\x00\\x10z0\\x00EW3si\\x98\\x00\\xbfCJfbm9uZV8i\\xb8\\x00\\x02\\x0b \\x00\\x88cGFuZGFz\\x9c\\x00\\xb0dW5pY29kZSI\\xe0\\x00\\xd0udW1weV90eXBlp\\x00\\xa1Im9iamVjdC \\x00\\xa5tZXRhZGF0Y\\x18\\x01@x9LC\\x98\\x01\\x0fH\\x01\\x10TCJfX2\\xc0\\x01\\xc1xldmVsXzBfXy\\\\\\x00\\x0f\\\\\\x01&gt;\\x80bnVsbH1d\\x1c\\x01\\xf0\\nY3JlYXRvciI6IHsibGlicmFye\\xc8\\x00\\xb1CJweWFycm93\\xa4\\x01\\xa1nZlcnNpb24\\xc0\\x01\\xa1MTEuMC4wIn\\x90\\x01\\x06\\xa8\\x00\\x80mVyc2lvbT\\x00\\xb0CIxLjUuMyJ9\\xc4\\x02\\x02\\xcb\\x02 BM\\n\\x00\\x10B\\x05\\x00\\xb1Mz///8AAAEF\\xe0\\x02\\x11CK\\x03\\x01\\x0b\\x00\\x01\\x02\\x00\\x10B\\x0b\\x00\\x1fB \\x01\\x03`wAAAMj@\\x00@QABQ\\x89\\x03`GAAcAD9\\x00\\x17BE\\x00!QUU\\x00\\x10H\\x18\\x00\\x02e\\x03\\x01\\x02\\x00\\x10B[\\x03\\x94F9ub25lXw3\\x00\\x01+\\x00\\x01\\x02\\x00\\xf1\\x00\\x00\\x18 parquet-cpp-9\\x04\\x13 \\x19\\x04\\x12 3\\x04P\\x19,\\x1c\\x00\\x00\\xdf\\x06\\x80\\x03\\x07\\x00\\x00PAR1\\x00\\x00\\x00\\x00&#39;
    &gt;&gt;&gt; unpack(b)
    a    5
    b    6
    dtype: object
    &gt;&gt;&gt; s = S({&#34;a&#34;: &#34;5&#34;, &#34;b&#34;: 6}, name=&#34;column&#34;)
    &gt;&gt;&gt; unpack(pack(s, ensure_determinism=True, unsafe_fallback=True))
    a    5
    b    6
    Name: column, dtype: object
    &gt;&gt;&gt; df = DF({&#34;a&#34;: [&#34;5&#34;,&#34;6&#34;,&#34;7&#34;], &#34;b&#34;: [1,2,3]}, index=[&#34;x&#34;,&#34;y&#34;,&#34;z&#34;])
    &gt;&gt;&gt; unpack(pack(df, ensure_determinism=True, unsafe_fallback=False))
       a  b
    x  5  1
    y  6  2
    z  7  3
    &gt;&gt;&gt; df = DF({&#34;a&#34;: [&#34;5&#34;,6,&#34;7&#34;], &#34;b&#34;: [&#34;1&#34;,&#34;2&#34;,&#34;3&#34;]}, index=[&#34;x&#34;,&#34;y&#34;,&#34;z&#34;])
    &gt;&gt;&gt; unpack(pack(df, ensure_determinism=True, unsafe_fallback=True))
       a  b
    x  5  1
    y  6  2
    z  7  3
    &#34;&#34;&#34;
    error = None
    if isinstance(obj, bytes):
        return obj
    if isinstance(obj, tuple):
        lst_of_binaries = tuple(traversal_enc(o, ensure_determinism, unsafe_fallback) for o in obj)
        return b&#34;00tupl_&#34; + bson.encode({&#34;_&#34;: lst_of_binaries})

    try:
        return b&#34;00json_&#34; + orjson.dumps(obj)
    except TypeError as e:
        error = str(e)
    try:
        return b&#34;00bson_&#34; + bson.encode({&#34;_&#34;: obj})
    except InvalidDocument as e:
        error = str(e)
    except OverflowError as o:
        if &#34;8-byte ints&#34; in str(o) and isinstance(obj, int):
            return b&#34;00bint_&#34; + str(obj).encode()

    if isinstance(obj, list):
        lst_of_binaries = [traversal_enc(o, ensure_determinism, unsafe_fallback) for o in obj]
        return b&#34;00list_&#34; + bson.encode({&#34;_&#34;: lst_of_binaries})
    elif isinstance(obj, dict):
        dic_of_binaries = {}
        hexfy = any(not isinstance(k, str) for k in obj.keys())
        prefix = b&#34;00dicB_&#34; if hexfy else b&#34;00dict_&#34;
        for k, o in obj.items():
            if hexfy:
                bk = traversal_enc(k, ensure_determinism, unsafe_fallback)
                k = hexlify(bk).decode(&#34;utf-8&#34;)
            dic_of_binaries[k] = traversal_enc(o, ensure_determinism, unsafe_fallback)
        return prefix + bson.encode(dic_of_binaries)

    klass = str(obj.__class__)
    if klass in [&#34;&lt;class &#39;numpy.ndarray&#39;&gt;&#34;]:
        return serialize_numpy(obj, ensure_determinism, unsafe_fallback)
    elif klass == &#34;&lt;class &#39;pandas.core.series.Series&#39;&gt;&#34;:
        try:
            idx = obj.index.values.tolist()
            vals = serialize_numpy(obj.to_numpy(), ensure_determinism, False, b&#34;&#34;)
            dic = {&#34;i&#34;: idx, &#34;v&#34;: vals}
            if obj.name is not None:
                dic[&#34;n&#34;] = obj.name
            return b&#34;00bsos_&#34; + bson.encode(dic)
        except Exception as e:
            if str(e).startswith(&#34;Please enable &#39;unsafe_fallback&#39;&#34;):
                from pandas import DataFrame

                try:
                    return b&#34;00prqs_&#34; + obj.to_frame(obj.name or &#34;_none_&#34;).to_parquet()  # .convert_dtypes().to_parquet()
                except Exception as e:
                    error = str(e)
    elif klass == &#34;&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;&#34;:
        try:
            return serialize_numpy(obj.to_numpy(), ensure_determinism, unsafe_fallback=False, prefix=b&#34;00npdf_&#34;)
        except Exception as e:
            if str(e).startswith(&#34;Please enable &#39;unsafe_fallback&#39;&#34;):
                try:
                    return b&#34;00prqd_&#34; + obj.to_parquet()
                except Exception as e:
                    error = str(e)
    if unsafe_fallback:
        return topickle(obj, ensure_determinism)
    raise Exception(f&#34;Cannot safely pack {type(obj)}: {error}&#34;)  # pragma: no cover
    # TODO: handle hdict?</code></pre>
</details>
</dd>
<dt id="safeserializer.compression.unpack"><code class="name flex">
<span>def <span class="ident">unpack</span></span>(<span>blob)</span>
</code></dt>
<dd>
<div class="desc"><pre><code class="language-python-repl">&gt;&gt;&gt; from pandas import DataFrame as DF
&gt;&gt;&gt; df = DF({&quot;a&quot;: [&quot;5&quot;, &quot;6&quot;, &quot;7&quot;], &quot;b&quot;: [1, 2, 3]}, index=[&quot;x&quot;, &quot;y&quot;, &quot;z&quot;])
&gt;&gt;&gt; complex_data = {&quot;a&quot;: b&quot;Some binary content&quot;, (&quot;mixed-types tuple as a key&quot;, 4): 123, &quot;df&quot;: df}
&gt;&gt;&gt; complex_data
{'a': b'Some binary content', ('mixed-types tuple as a key', 4): 123, 'df':    a  b
x  5  1
y  6  2
z  7  3}
&gt;&gt;&gt; dump = pack(complex_data, ensure_determinism=False, unsafe_fallback=False)
&gt;&gt;&gt; dump
b'00lz4__\x04&quot;M\x18h@h\x0b\x00\x00\x00\x00\x00\x00\x94\x95\x06\x00\x00\xf1*00dicB_a\x0b\x00\x00\x0530306a736f6e5f226122\x00\x13\x00\x00\x00\x00Some binary content.\x00\xd27475706c5f480\x01\x00b45f004\x0c\x00\x8000530002\x05\x00\x01\x02\x00\rb\x00\xf5\x07d697865642d74797065732X\x00`652061\x12\x00\xf4\x0461206b6579220531000r\x00\x0bV\x00\x113}\x00 \x00\n\xb8\x00\xa100json_123\xaf\x00\t\xdd\x00p46622\x00b(\x00\xf0\x1100prqd_PAR1\x15\x04\x15\x1e\x15&quot;L\x15\x06\x15\x00\x12\x00\x00\x0f8\x01\x00\x00\x005\x05\x00\x106\x05\x00\xf667\x15\x00\x15\x14\x15\x18,\x15\x06\x15\x10\x15\x06\x15\x06\x1c6\x00(\x017\x18\x015\x00\x00\x00\n$\x02\x00\x00\x00\x06\x01\x02\x03$\x00&amp;\x94\x01\x1c\x15\x0c\x195\x10\x00\x06\x19\x18\x01a\x15\x02\x16\x06\x16\x84\x01\x16\x8c\x01&amp;F&amp;\x085\x00\xe0\x19,\x15\x04\x15\x00\x15\x02\x00\x15\x00\x15\x10\x15?\x00d\x15\x04\x150\x15.\x7f\x00p\x18\x04\x01\x00\t\x01&lt;\x19\x00\x00\x02\x00\x10\x03\x05\x00 \x00\x00.\x00\t\x85\x00$\x18\x08\x1a\x00 \x18\x08\xa6\x00\x00\x02\x00?\x16\x00(\x16\x00\x00\x0c\xa7\x00T\xe2\x03\x1c\x15\x04\xa7\x00\x11b\xa7\x00\xbf\xda\x01\x16\xdc\x01&amp;\xd0\x02&amp;\x86\x02Y\x00\x19\x0f\xcb\x00\x02\rJ\x01\x10x\x9f\x00\x10y\x05\x00\x1fzJ\x01\x01Lz\x18\x01x\xa3\x00&amp;\xa8\x06J\x01\xf1\x03\x11__index_level_0__\xb3\x00\x02Z\x01Q\xda\x05&amp;\x9c\x05\x91\x01\x01G\x00\x0f\x91\x00\x01\xf0\x0b\x19L5\x00\x18\x06schema\x15\x06\x00\x15\x0c%\x02\x18\x01a%\x00L\x1cV\x01\x10\x04\x0e\x00\x12b\x16\x00\x0ej\x00\x03&amp;\x00o\x16\x06\x19\x1c\x19&lt;\xe0\x01&amp;\x0fr\x01J\x0f,\x018\xb0\x16\xe2\x03\x16\x06&amp;\x08\x16\xf4\x03\x14\xdc\x01\xd2\x18\x06pandas\x18\xd5\x04{&quot;\x83\x01\xcdcolumns&quot;: [&quot;\x97\x01R&quot;], &quot;&quot;\x00\x02\xb2\x01\x11e)\x00\xfa\x07{&quot;name&quot;: null, &quot;field_\x14\x00\x02i\x00@_typ)\x00\xf5\x02&quot;unicode&quot;, &quot;numpy\x19\x00`object\x18\x00\xf6\x12metadata&quot;: {&quot;encoding&quot;: &quot;UTF-8&quot;}}\x8d\x00\n\x86\x00 &quot;a?\x00\t\x85\x00\x02\x13\x00\x0f\x84\x00*\x00\xdc\x005}, \xec\x00.&quot;bf\x00\x01\x13\x00\x0bf\x00Pint64+\x00\n\xe8\x00\x05\x17\x00\x07\xe7\x00\x0cc\x00\x00\x10\x00\x0cO\x01\x0f\x95\x01\x00\x0et\x00\x0f^\x01\x1b\x00g\x00\x02M\x01areatorq\x01plibraryp\x01ppyarrow\xc4\x00pversion\x16\x00\x8611.0.0&quot;}~\x00\x08\x1d\x00\xf2\x00.5.3&quot;}\x00\x18\x0cARROW:\x9c\x03@\x18\x98\t/\x01\x00\x822gDAAAQA\x01\x00\xf1\x00KAA4ABgAFAAgACg\x15\x00)BB \x00\x10w\x15\x00\x15E \x002IwC\x10\x00\x04F\x00\x01 \x00\x10I\x08\x00\x11B\x08\x00\x01E\x00\x10I \x00\x10E\x05\x00\xf4GAYAAABwYW5kYXMAAFUCAAB7ImluZGV4X2NvbHVtbnMiOiBbIl9faW5kZXhfbGV2ZWxfMF9fIl0sICJjb2x1bW5$\x00\xf0\x01lcyI6IFt7Im5hbWUD\x00\xf0\x11udWxsLCAiZmllbGRfbmFtZSI6IG51bGwH\x00\x03\x90\x00aNfdHlw\x1c\x00\xf0\x0eCJ1bmljb2RlIiwgIm51bXB5X3R5cGX\x00\xa2Aib2JqZWN0 \x00\xf0\x0c1ldGFkYXRhIjogeyJlbmNvZGluZ\x94\x00\xe0CJVVEYtOCJ9fV0t\x00\x04\xbc\x00\x10z0\x00EW3si\x98\x002CJhT\x00\x84ZpZWxkX2\xcc\x00PAiYSI&lt;\x00\x0f\xb0\x00&gt;\xa9bnVsbH0sIH\x88\x00\x1fi\x88\x00\x06\x1fi\x88\x00\x06qpbnQ2NC \x00\xd0udW1weV90eXBl\xe8\x00\x00\xe8\x01?dDY4\x01\x02\x0f\x84\x00\x02\x06\xa4\x01\xc2maWVsZF9uYW1L\x00\x0f\x1c\x02\x05\x00\xb0\x01\x97nBhbmRhc1|\x00PnVuaW\x94\x01 Ui\x10\x02xbnVtcHl\xf4\x01\x82vYmplY3Q \x00\xa5WV0YWRhdGEH\x02\x04\xbc\x01\x80cmVhdG9y\xd4\x00\xc0eyJsaWJyYXJ5\x10\x00\xb1InB5YXJyb3cH\x00\xf9\x0bdmVyc2lvbiI6ICIxMS4wLjAifS\xa8\x00\x912ZXJzaW9uD\x00\xa0jEuNS4zIn06\x03\x00\xa4\x03!Ah\n\x00\x01`\x03\x01K\x03PmP///\x0f\x00!QU\xc0\x03\x10J \x00\x05\xcb\x030AAE\x16\x00\x1fF$\x01\x03\x00 \x00\x01@\x00`8z///8\xc3\x03\x11CU\x00\x10BQ\x00\x11A\x0b\x00\x02\x02\x00\x00\x0b\x00 Bi\x0c\x00@CAAM\xd0\x03&quot;Bw\xd0\x03\x01\x02\x00\x11U\x06\x00\xc2QABQACAAGAAc\xad\x00\x12B:\x00\x01\x02\x00\x03\xa0\x00\x12G\r\x00\x01\x06\x00\x01\x02\x00\x00\xa0\x00\x10G`\x00\x00p\x001QAB\x15\x00\xf1\x02==\x00\x18 parquet-cpp-\xf1\x04\x13 \xd1\x04\x12 \xeb\x04R\x19&lt;\x1c\x00\x00\x03\x00\xa0\x00t\x08\x00\x00PAR1\x00\x00\x00\x00\x00'
&gt;&gt;&gt; unpack(dump)
{'a': b'Some binary content', ('mixed-types tuple as a key', 4): 123, 'df':    a  b
x  5  1
y  6  2
z  7  3}
</code></pre></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def unpack(blob):
    &#34;&#34;&#34;
    &gt;&gt;&gt; from pandas import DataFrame as DF
    &gt;&gt;&gt; df = DF({&#34;a&#34;: [&#34;5&#34;, &#34;6&#34;, &#34;7&#34;], &#34;b&#34;: [1, 2, 3]}, index=[&#34;x&#34;, &#34;y&#34;, &#34;z&#34;])
    &gt;&gt;&gt; complex_data = {&#34;a&#34;: b&#34;Some binary content&#34;, (&#34;mixed-types tuple as a key&#34;, 4): 123, &#34;df&#34;: df}
    &gt;&gt;&gt; complex_data
    {&#39;a&#39;: b&#39;Some binary content&#39;, (&#39;mixed-types tuple as a key&#39;, 4): 123, &#39;df&#39;:    a  b
    x  5  1
    y  6  2
    z  7  3}
    &gt;&gt;&gt; dump = pack(complex_data, ensure_determinism=False, unsafe_fallback=False)
    &gt;&gt;&gt; dump
    b&#39;00lz4__\\x04&#34;M\\x18h@h\\x0b\\x00\\x00\\x00\\x00\\x00\\x00\\x94\\x95\\x06\\x00\\x00\\xf1*00dicB_a\\x0b\\x00\\x00\\x0530306a736f6e5f226122\\x00\\x13\\x00\\x00\\x00\\x00Some binary content.\\x00\\xd27475706c5f480\\x01\\x00b45f004\\x0c\\x00\\x8000530002\\x05\\x00\\x01\\x02\\x00\\rb\\x00\\xf5\\x07d697865642d74797065732X\\x00`652061\\x12\\x00\\xf4\\x0461206b6579220531000r\\x00\\x0bV\\x00\\x113}\\x00 \\x00\\n\\xb8\\x00\\xa100json_123\\xaf\\x00\\t\\xdd\\x00p46622\\x00b(\\x00\\xf0\\x1100prqd_PAR1\\x15\\x04\\x15\\x1e\\x15&#34;L\\x15\\x06\\x15\\x00\\x12\\x00\\x00\\x0f8\\x01\\x00\\x00\\x005\\x05\\x00\\x106\\x05\\x00\\xf667\\x15\\x00\\x15\\x14\\x15\\x18,\\x15\\x06\\x15\\x10\\x15\\x06\\x15\\x06\\x1c6\\x00(\\x017\\x18\\x015\\x00\\x00\\x00\\n$\\x02\\x00\\x00\\x00\\x06\\x01\\x02\\x03$\\x00&amp;\\x94\\x01\\x1c\\x15\\x0c\\x195\\x10\\x00\\x06\\x19\\x18\\x01a\\x15\\x02\\x16\\x06\\x16\\x84\\x01\\x16\\x8c\\x01&amp;F&amp;\\x085\\x00\\xe0\\x19,\\x15\\x04\\x15\\x00\\x15\\x02\\x00\\x15\\x00\\x15\\x10\\x15?\\x00d\\x15\\x04\\x150\\x15.\\x7f\\x00p\\x18\\x04\\x01\\x00\\t\\x01&lt;\\x19\\x00\\x00\\x02\\x00\\x10\\x03\\x05\\x00 \\x00\\x00.\\x00\\t\\x85\\x00$\\x18\\x08\\x1a\\x00 \\x18\\x08\\xa6\\x00\\x00\\x02\\x00?\\x16\\x00(\\x16\\x00\\x00\\x0c\\xa7\\x00T\\xe2\\x03\\x1c\\x15\\x04\\xa7\\x00\\x11b\\xa7\\x00\\xbf\\xda\\x01\\x16\\xdc\\x01&amp;\\xd0\\x02&amp;\\x86\\x02Y\\x00\\x19\\x0f\\xcb\\x00\\x02\\rJ\\x01\\x10x\\x9f\\x00\\x10y\\x05\\x00\\x1fzJ\\x01\\x01Lz\\x18\\x01x\\xa3\\x00&amp;\\xa8\\x06J\\x01\\xf1\\x03\\x11__index_level_0__\\xb3\\x00\\x02Z\\x01Q\\xda\\x05&amp;\\x9c\\x05\\x91\\x01\\x01G\\x00\\x0f\\x91\\x00\\x01\\xf0\\x0b\\x19L5\\x00\\x18\\x06schema\\x15\\x06\\x00\\x15\\x0c%\\x02\\x18\\x01a%\\x00L\\x1cV\\x01\\x10\\x04\\x0e\\x00\\x12b\\x16\\x00\\x0ej\\x00\\x03&amp;\\x00o\\x16\\x06\\x19\\x1c\\x19&lt;\\xe0\\x01&amp;\\x0fr\\x01J\\x0f,\\x018\\xb0\\x16\\xe2\\x03\\x16\\x06&amp;\\x08\\x16\\xf4\\x03\\x14\\xdc\\x01\\xd2\\x18\\x06pandas\\x18\\xd5\\x04{&#34;\\x83\\x01\\xcdcolumns&#34;: [&#34;\\x97\\x01R&#34;], &#34;&#34;\\x00\\x02\\xb2\\x01\\x11e)\\x00\\xfa\\x07{&#34;name&#34;: null, &#34;field_\\x14\\x00\\x02i\\x00@_typ)\\x00\\xf5\\x02&#34;unicode&#34;, &#34;numpy\\x19\\x00`object\\x18\\x00\\xf6\\x12metadata&#34;: {&#34;encoding&#34;: &#34;UTF-8&#34;}}\\x8d\\x00\\n\\x86\\x00 &#34;a?\\x00\\t\\x85\\x00\\x02\\x13\\x00\\x0f\\x84\\x00*\\x00\\xdc\\x005}, \\xec\\x00.&#34;bf\\x00\\x01\\x13\\x00\\x0bf\\x00Pint64+\\x00\\n\\xe8\\x00\\x05\\x17\\x00\\x07\\xe7\\x00\\x0cc\\x00\\x00\\x10\\x00\\x0cO\\x01\\x0f\\x95\\x01\\x00\\x0et\\x00\\x0f^\\x01\\x1b\\x00g\\x00\\x02M\\x01areatorq\\x01plibraryp\\x01ppyarrow\\xc4\\x00pversion\\x16\\x00\\x8611.0.0&#34;}~\\x00\\x08\\x1d\\x00\\xf2\\x00.5.3&#34;}\\x00\\x18\\x0cARROW:\\x9c\\x03@\\x18\\x98\\t/\\x01\\x00\\x822gDAAAQA\\x01\\x00\\xf1\\x00KAA4ABgAFAAgACg\\x15\\x00)BB \\x00\\x10w\\x15\\x00\\x15E \\x002IwC\\x10\\x00\\x04F\\x00\\x01 \\x00\\x10I\\x08\\x00\\x11B\\x08\\x00\\x01E\\x00\\x10I \\x00\\x10E\\x05\\x00\\xf4GAYAAABwYW5kYXMAAFUCAAB7ImluZGV4X2NvbHVtbnMiOiBbIl9faW5kZXhfbGV2ZWxfMF9fIl0sICJjb2x1bW5$\\x00\\xf0\\x01lcyI6IFt7Im5hbWUD\\x00\\xf0\\x11udWxsLCAiZmllbGRfbmFtZSI6IG51bGwH\\x00\\x03\\x90\\x00aNfdHlw\\x1c\\x00\\xf0\\x0eCJ1bmljb2RlIiwgIm51bXB5X3R5cGX\\x00\\xa2Aib2JqZWN0 \\x00\\xf0\\x0c1ldGFkYXRhIjogeyJlbmNvZGluZ\\x94\\x00\\xe0CJVVEYtOCJ9fV0t\\x00\\x04\\xbc\\x00\\x10z0\\x00EW3si\\x98\\x002CJhT\\x00\\x84ZpZWxkX2\\xcc\\x00PAiYSI&lt;\\x00\\x0f\\xb0\\x00&gt;\\xa9bnVsbH0sIH\\x88\\x00\\x1fi\\x88\\x00\\x06\\x1fi\\x88\\x00\\x06qpbnQ2NC \\x00\\xd0udW1weV90eXBl\\xe8\\x00\\x00\\xe8\\x01?dDY4\\x01\\x02\\x0f\\x84\\x00\\x02\\x06\\xa4\\x01\\xc2maWVsZF9uYW1L\\x00\\x0f\\x1c\\x02\\x05\\x00\\xb0\\x01\\x97nBhbmRhc1|\\x00PnVuaW\\x94\\x01 Ui\\x10\\x02xbnVtcHl\\xf4\\x01\\x82vYmplY3Q \\x00\\xa5WV0YWRhdGEH\\x02\\x04\\xbc\\x01\\x80cmVhdG9y\\xd4\\x00\\xc0eyJsaWJyYXJ5\\x10\\x00\\xb1InB5YXJyb3cH\\x00\\xf9\\x0bdmVyc2lvbiI6ICIxMS4wLjAifS\\xa8\\x00\\x912ZXJzaW9uD\\x00\\xa0jEuNS4zIn06\\x03\\x00\\xa4\\x03!Ah\\n\\x00\\x01`\\x03\\x01K\\x03PmP///\\x0f\\x00!QU\\xc0\\x03\\x10J \\x00\\x05\\xcb\\x030AAE\\x16\\x00\\x1fF$\\x01\\x03\\x00 \\x00\\x01@\\x00`8z///8\\xc3\\x03\\x11CU\\x00\\x10BQ\\x00\\x11A\\x0b\\x00\\x02\\x02\\x00\\x00\\x0b\\x00 Bi\\x0c\\x00@CAAM\\xd0\\x03&#34;Bw\\xd0\\x03\\x01\\x02\\x00\\x11U\\x06\\x00\\xc2QABQACAAGAAc\\xad\\x00\\x12B:\\x00\\x01\\x02\\x00\\x03\\xa0\\x00\\x12G\\r\\x00\\x01\\x06\\x00\\x01\\x02\\x00\\x00\\xa0\\x00\\x10G`\\x00\\x00p\\x001QAB\\x15\\x00\\xf1\\x02==\\x00\\x18 parquet-cpp-\\xf1\\x04\\x13 \\xd1\\x04\\x12 \\xeb\\x04R\\x19&lt;\\x1c\\x00\\x00\\x03\\x00\\xa0\\x00t\\x08\\x00\\x00PAR1\\x00\\x00\\x00\\x00\\x00&#39;
    &gt;&gt;&gt; unpack(dump)
    {&#39;a&#39;: b&#39;Some binary content&#39;, (&#39;mixed-types tuple as a key&#39;, 4): 123, &#39;df&#39;:    a  b
    x  5  1
    y  6  2
    z  7  3}
    &#34;&#34;&#34;
    if blob[:7] == b&#34;00lz4__&#34;:
        import lz4.frame as lz4

        blob = lz4.decompress(blob[7:])
    return traversal_dec(blob)</code></pre>
</details>
</dd>
</dl>
</section>
<section>
<h2 class="section-title" id="header-classes">Classes</h2>
<dl>
<dt id="safeserializer.compression.NondeterminismException"><code class="flex name class">
<span>class <span class="ident">NondeterminismException</span></span>
<span>(</span><span>*args, **kwargs)</span>
</code></dt>
<dd>
<div class="desc"><p>Common base class for all non-exit exceptions.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class NondeterminismException(Exception):
    pass</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<li>builtins.Exception</li>
<li>builtins.BaseException</li>
</ul>
</dd>
</dl>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="safeserializer" href="index.html">safeserializer</a></code></li>
</ul>
</li>
<li><h3><a href="#header-functions">Functions</a></h3>
<ul class="two-column">
<li><code><a title="safeserializer.compression.bytes2integers" href="#safeserializer.compression.bytes2integers">bytes2integers</a></code></li>
<li><code><a title="safeserializer.compression.deserialize_numpy" href="#safeserializer.compression.deserialize_numpy">deserialize_numpy</a></code></li>
<li><code><a title="safeserializer.compression.frompickle" href="#safeserializer.compression.frompickle">frompickle</a></code></li>
<li><code><a title="safeserializer.compression.integers2bytes" href="#safeserializer.compression.integers2bytes">integers2bytes</a></code></li>
<li><code><a title="safeserializer.compression.pack" href="#safeserializer.compression.pack">pack</a></code></li>
<li><code><a title="safeserializer.compression.serialize_numpy" href="#safeserializer.compression.serialize_numpy">serialize_numpy</a></code></li>
<li><code><a title="safeserializer.compression.topickle" href="#safeserializer.compression.topickle">topickle</a></code></li>
<li><code><a title="safeserializer.compression.traversal_dec" href="#safeserializer.compression.traversal_dec">traversal_dec</a></code></li>
<li><code><a title="safeserializer.compression.traversal_enc" href="#safeserializer.compression.traversal_enc">traversal_enc</a></code></li>
<li><code><a title="safeserializer.compression.unpack" href="#safeserializer.compression.unpack">unpack</a></code></li>
</ul>
</li>
<li><h3><a href="#header-classes">Classes</a></h3>
<ul>
<li>
<h4><code><a title="safeserializer.compression.NondeterminismException" href="#safeserializer.compression.NondeterminismException">NondeterminismException</a></code></h4>
</li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc" title="pdoc: Python API documentation generator"><cite>pdoc</cite> 0.10.0</a>.</p>
</footer>
</body>
</html>